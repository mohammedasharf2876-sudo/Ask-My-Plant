<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0b3d2e"/>
  <title>ask my plant</title>

  <style>
    :root{
      --bg:#071a14; --line:rgba(255,255,255,.10);
      --text:#eafff6; --muted:#a6d9c8;
      --accent:#37c58b; --accent2:#18a56c;
      --shadow:0 12px 28px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; height:100vh;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(55,197,139,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(24,165,108,.14), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;
      display:flex; justify-content:center;
    }
    .app{
      width:100%; max-width:520px; height:100vh;
      display:flex; flex-direction:column;
      padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
      gap:10px;
    }
    .top{padding:10px 10px 0}
    .brand{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .logo{display:flex;align-items:center;gap:10px;min-width:0}
    .pill{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:grid;place-items:center; box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .logo h1{margin:0;font-size:18px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .logo .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}

    .toggles{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .chipbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px; border-radius:999px;
      font-weight:800; font-size:12px;
      cursor:pointer;
    }

    .plantCard{
      margin-top:10px;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:10px;
      display:flex; gap:10px; align-items:center;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    .pimg{
      width:64px;height:64px;border-radius:16px;overflow:hidden;
      border:1px solid var(--line);
      flex:0 0 auto;
      background:rgba(255,255,255,.05);
      position:relative;
    }
    .pimg img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute; bottom:6px; left:6px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
      color:#fff; font-size:11px; font-weight:900;
      padding:3px 8px; border-radius:999px;
      backdrop-filter:blur(8px);
    }
    .pmeta{min-width:0;flex:1}
    .pmeta .pname{font-weight:900;font-size:14px;margin:0 0 2px}
    .pmeta .pdesc{font-size:12px;color:var(--muted);margin:0;line-height:1.5}

    .quick{
      display:flex; gap:8px; padding:8px 10px 0;
      overflow:auto; scrollbar-width:none;
    }
    .quick::-webkit-scrollbar{display:none}
    .q{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      font-weight:900; font-size:13px;
      white-space:nowrap; cursor:pointer;
      user-select:none;
    }
    .q:active{transform:scale(.98)}

    #chat{
      flex:1; overflow:auto; padding:12px 10px 0;
      display:flex; flex-direction:column; gap:10px;
    }
    .msg{
      max-width:92%;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 10px 20px rgba(0,0,0,.22);
      line-height:1.75;
      font-size:14px;
      word-break:break-word;
      background:rgba(255,255,255,.06);
    }
    .bot{align-self:flex-start;border-bottom-right-radius:8px}
    .user{align-self:flex-end;border-bottom-left-radius:8px;background:rgba(55,197,139,.18);border-color:rgba(55,197,139,.30)}
    .meta{margin-top:8px;font-size:12px;color:var(--muted)}

    .typing{display:inline-flex;align-items:center;gap:8px;color:var(--muted);font-weight:800;font-size:13px}
    .dots{display:inline-flex;gap:4px}
    .dot{width:6px;height:6px;border-radius:50%;background:var(--muted);animation:b 1s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}

    .composer{
      padding:10px; display:flex; gap:8px; align-items:flex-end;
      position:sticky; bottom:0;
      background:linear-gradient(180deg,transparent,rgba(7,26,20,.88) 25%,rgba(7,26,20,.98));
      backdrop-filter:blur(8px);
    }
    .box{
      flex:1;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      border-radius:18px;
      padding:10px 10px 8px;
      display:flex; flex-direction:column; gap:8px;
    }
    textarea{
      width:100%; resize:none;
      min-height:44px; max-height:140px;
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px; line-height:1.6;
    }
    .attachRow{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .small{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;min-width:0}
    .btn{
      border:none; cursor:pointer; font-weight:900;
      border-radius:16px; padding:12px 14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#062016; box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .btn2{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:16px;
      padding:12px 12px;
      cursor:pointer;
      flex:0 0 auto;
    }
    .img-reply{
      width:100%; max-width:360px;
      border-radius:16px; overflow:hidden;
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      margin-top:10px; display:block;
    }

    /* mini action buttons inside bot message */
    .mini-actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .mini-actions button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;border-radius:999px;
      cursor:pointer;font-weight:900;font-size:12px;
    }
    .mini-actions button:active{transform:scale(.98)}
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brand">
        <div class="logo">
          <div class="pill">๐ฟ</div>
          <div style="min-width:0">
            <h1>ask my plant</h1>
            <div class="sub" id="subtitle">offline smart plant chat</div>
          </div>
        </div>
        <div class="toggles">
          <button class="chipbtn" onclick="showHelp()">ุงูุฃูุงูุฑ</button>
          <button class="chipbtn" onclick="showPlantList()">ุงูุฃููุงุน</button>
          <button class="chipbtn" onclick="resetChat()">New chat</button>
        </div>
      </div>

      <div class="plantCard">
        <div class="pimg">
          <img id="plantImg" alt="plant"/>
          <div class="badge" id="imgBadge">ุตูุฑุฉ</div>
        </div>
        <div class="pmeta">
          <p class="pname" id="plantName">โ</p>
          <p class="pdesc" id="plantDesc">โ</p>
        </div>
      </div>

      <div class="quick" id="quickRow"></div>
    </div>

    <div id="chat"></div>

    <div class="composer">
      <button class="btn2" onclick="nextPhoto()">๐ผ๏ธ</button>

      <div class="box">
        <textarea id="input" placeholder="ุงุณุฃู ุฃู ุณุคุงูโฆ (ุงุฒููุ ุฑูุ ุงุตูุฑุงุฑุ ุจูุนุ ุญุดุฑุงุชุ)"></textarea>
        <div class="attachRow">
          <div class="small">
            <span id="hint">ุงูุชุจ ุงุณู ุฒุฑุนุฉ ููุญุฏู ุนุดุงู ุฃุญูููู ุนูููุง (ูุซูุงู: ูุงุณููู)</span>
          </div>
          <button class="btn" onclick="send()">Send</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================
   1) Plant DB (ูู ุงูููุฏ ุจุชุงุนู)
========================================= */
const plantDB = {
  // ุนุทุฑูุงุช ูุฃุนุดุงุจ
  "ุฑูุญุงู": { w:"ููู ูููู (ุงูุชุฑุจุฉ ุฑุทุจุฉ ุฏุงุฆูุงู)", s:"ุดูุณ ูุจุงุดุฑุฉ ูููุงู ูุชููู", f:"ุณูุงุฏ ุนุถูู ูู ุดูุฑ", n:"ุงูุทู ุงูููู ุงููุงููุฉ ุนุดุงู ููุจุฑ ูููุฑุน.", aliases:["ุญุจู"] },
  "ูุนูุงุน": { w:"ูู ููู ูู ุงูุตูู (ุจูุญุจ ุงูููุฉ)", s:"ุดูุณ ุฎูููุฉ ุฃู ูุตู ุธู", f:"ุณูุงุฏ ูุชูุงุฒู NPK", n:"ุงูุฌุฐูุฑ ุจุชูุชุฏ ุจุณุฑุนุฉุ ููุถู ูู ุฃุตูุต ููุญุฏู.", aliases:["ูุนูุงุน ุจูุฏู"] },
  "ุฑูุฒูุงุฑู": { w:"ููุง ุงูุชุฑุจุฉ ุชูุดู ุชูุงูุงู", s:"ุดูุณ ุญุงุฑูุฉ (ุจูุชุญูู)", f:"ูุด ูุญุชุงุฌ ุชุณููุฏ ูุชูุฑ", n:"ููุชุงุฒ ูู ุงูุทุจุฎ ูุฑูุญุชู ุจุชุทุฑุฏ ุงูุญุดุฑุงุช.", aliases:["ุฅูููู ุงูุฌุจู"] },
  "ุฒุนุชุฑ": { w:"ูููู ุฌุฏุงู (ุจููุฑู ุงูููุฉ ุงููุชูุฑ)", s:"ุดูุณ ูุงููุฉ", f:"ูุฑุฉ ูู ููุณู", n:"ุนุดุจุฉ ูููุฉ ูุจุชุชุญูู ุงูุฌูุงู.", aliases:["ุฒุนุชุฑ ุจูุฏู"] },
  "ูุงููุฏุฑ": { w:"ููุง ุงูุชุฑุจุฉ ุชุฌู (ุจููุฑู ุงูุฑุทูุจุฉ)", s:"ุดูุณ ูููุฉ ุฌุฏุงู", f:"ูููู ุฌุฏุงู", n:"ุฑูุญุชู ููุฏุฆุฉ ูุจูุญุจ ุงูุฌู ุงูุฌุงู.", aliases:["ุฎุฒุงูู"] },

  // ุฒููุฑ ููุฒูุฑุงุช
  "ูุฑุฏ ุจูุฏู": { w:"ููู ูููู ุจุงูุชุธุงู", s:"ุดูุณ ูุจุงุดุฑุฉ 6 ุณุงุนุงุช ุนุงูุฃูู", f:"NPK ุนุงูู ุงูุจูุชุงุณููู ุนุดุงู ูุฒูุฑ", n:"ูุต ุงููุฑุฏ ุงูุฏุจูุงู ุฃูู ุจุฃูู ุนุดุงู ูุทูุน ุฌุฏูุฏ.", aliases:["ูุฑุฏ"] },
  "ูู": { w:"ูู ููููู (ุชุฑุจุฉ ุฑุทุจุฉ)", s:"ุดูุณ ูุบุฑุจูุฉ (ูุด ุญุงุฑูุฉ)", f:"ุญุฏูุฏ ูู ุดูุฑ ุนุดุงู ุงููุฑู ููุตูุฑุด", n:"ุฑูุญุชู ููุงุญุฉ ุฌุฏุงู ููุช ุงูุบุฑูุจ.", aliases:["ูู ุจูุฏู"] },
  "ูุงุณููู": { w:"ูุนุชุฏู (ููุง ุงููุด ููุดู)", s:"ุดูุณ ูุงููุฉ", f:"ุณูุงุฏ ูุชูุงุฒู", n:"ูุจุงุช ูุชุณููุ ูุญุชุงุฌ ุฏุนุงูุฉ ูุณูุฏ ุนูููุง.", aliases:["ูุงุณููู ูุชุณูู"] },
  "ุฌุงุฑุฏูููุง": { w:"ููุฉ ุฎุงููุฉ ูู ุงููููุฑ (ููุชุฑ)", s:"ุถูุก ููู ุฌุฏุงู ุจุณ ูุด ุดูุณ ูุจุงุดุฑุฉ", f:"ุญุฏูุฏ ูุณูุงุฏ ุญุงูุถู", n:"ุฏููุนุฉ ุงููุดุชูุ ุจุชุฒุนู ูู ููุงููุง ุงุชุบูุฑ.", aliases:["Gardenia"] },
  "ูุณู ุงูููู": { w:"ููู ูููู", s:"ุดูุณ ูุจุงุดุฑุฉ", f:"ุณูุงุฏ ุจูุฏู", n:"ุฑูุญุชู ุจุชููุฃ ุงูุดุงุฑุน ููู ุจููู.", aliases:["ูุณู"] },
  "ุฌููููุฉ": { w:"ุชุนุทูุด ุนุดุงู ุชุฒูุฑ (ูููู)", s:"ุดูุณ ุญุงุฑูุฉ ุทูู ุงูููู", f:"ูุด ูุญุชุงุฌุฉ ุฏูุน", n:"ูู ูุง ุชูุดู ุนูููุง ุงูููุฉ ุชุทูุน ูุฑุฏ ุฃูุชุฑ.", aliases:["ุจูฺููููุง","ุจูุบููููุง"] },
  "ูุงูุจุณูุณ": { w:"ููู ูููู ูู ุงูุตูู", s:"ุดูุณ ูุจุงุดุฑุฉ", f:"NPK ูู ุฃุณุจูุนูู", n:"ุฒูุฑุชูุง ุจุชุนูุด ููู ูุงุญุฏ ุจุณ ุดูููุง ุฑูุนุฉ.", aliases:["ููุจุณูุณ","ูุฑูุฏูู ุฒููุฉ"] },
  "ูููุง": { w:"ูู ููู ูู ุงูุญุฑ", s:"ุดูุณ ุฃู ูุตู ุธู", f:"NPK ูุชุนุงุฏู", n:"ุฃููู ูุจุงุช ูุฒูุฑ ุจูุณุชุญูู ุญุฑุงุฑุฉ ูุตุฑ.", aliases:["ูููุง ุฑูุฒ"] },
  "ุฌุงุฑูููุง": { w:"ูุนุชุฏู", s:"ุดูุณ ุงูุตุจุญ ุจุณ", f:"ุจูุชุงุณููู ููุชุฒููุฑ", n:"ุฑูุญุชูุง ูููุฒุฉ ูุจุชุทุฑุฏ ุงููุงููุณ.", aliases:["ุฌุฑุงูููู","ุฅุจุฑุฉ ุงูุฑุงุนู"] },

  // ูุจุงุชุงุช ุฒููุฉ ุฏุงุฎููุฉ
  "ุจูุชุณ": { w:"ูู 4-5 ุฃูุงู (ููุง ุงูุชุฑุจุฉ ุชูุดู)", s:"ุถูุก ููุจุฉ ุฃู ุดุจุงู (ุถู)", f:"ุณูุงุฏ ูุฑูู", n:"ุฃุณูู ุฒุฑุนุฉ ูููุจุชุฏุฆููุ ุจุชุนูุด ูู ุฃู ุญุชุฉ.", aliases:["Pothos","ุจูุชุณ ุฐูุจู"] },
  "ุฌูุฏ ุงูููุฑ": { w:"ูู ุฃุณุจูุนูู ูุฑุฉ (ุงูุณุงู)", s:"ุฃู ุฅุถุงุกุฉ (ูููุฉ ุฃู ุถุนููุฉ)", f:"ูุด ูุญุชุงุฌ", n:"ุจูููู ุงูููุง ููุจูููุชุด ุจุณูููุฉ.", aliases:["ุณุงูุณูููุฑูุง","ุณูุณููุฑูุง"] },
  "ุฒุงููุง": { w:"ูุฑุฉ ูู 20 ููู (ุฌุฐูุฑู ุจุชุฎุฒู ููุฉ)", s:"ุถู ูุงูู ุฃู ุถูุก ุฎููู", f:"NPK ูู ุดูุฑูู", n:"ุงูุฒุฑุนุฉ ุงูุดููุ ูุฑููุง ุจูููุน ููุญุฏู.", aliases:["ZZ"] },
  "ูููุณุชููุฑุง": { w:"ููุง ูุต ุงูุชุฑุจุฉ ููุดู", s:"ุถูุก ุณุงุทุน ุบูุฑ ูุจุงุดุฑ", f:"NPK", n:"ุงููุฑู ุจูุชูุทุน ุดููู ุชุญูุฉุ ุจุชุญุจ ุฑุทูุจุฉ ุงูุฌู (ุจุฎูุง ููุฉ).", aliases:["ูููุณุชูุฑุง"] },
  "ุฏุฑุงุณูุจูุง": { w:"ูุนุชุฏู", s:"ุถูุก ูุชูุณุท", f:"ุณูุงุฏ ุฃุฎุถุฑ", n:"ุดูููุง ุฒู ุงููุฎูุฉ ุงูุตุบูุฑุฉุ ุจุชููู ุงูุฌู.", aliases:["ุฏุฑุงุณููุง"] },
  "ุณูุฌููููู": { w:"ุฑุทูุจุฉ ูุณุชูุฑุฉ", s:"ุถู", f:"NPK", n:"ูุฑููุง ุดุจู ุงูุณููุ ุจุชูุจุฑ ุจุณุฑุนุฉ.", aliases:["ุณูุบููููู"] },
  "ุงูุชูุฑููู": { w:"ููุฉ ูููุชุฑุฉ", s:"ุถูุก ููู ุฌุฏุงู ุฌูู ุงูุจูุช", f:"ุณูุงุฏ ุฒููุฑ", n:"ุฒูุฑุชูุง ุญูุฑุงุก ูุดูููุง ุจูุงุณุชูู ูู ูุชุฑ ุงูุฌูุงู.", aliases:["ุฃูุซูุฑููู"] },
  "ูููุณ ุฏูููุฑุง": { w:"ููุง ุงูุชุฑุจุฉ ุชูุดู ุชูุงูุงู", s:"ุถูุก ุดุจุงู ููู", f:"NPK", n:"ุงูุณุญ ูุฑููุง ุจููุงุดุฉ ูุจูููุฉ ุนุดุงู ูููุน.", aliases:["ูููุณ ูุทุงุท","Rubber plant"] },
  "ุจุงูุจู": { w:"ุบูุฑ ุงูููุฉ ูู ุฃุณุจูุน (ูู ูู ูุงุฒุฉ)", s:"ุถูุก ุบุฑูุฉ", f:"ููุทุชูู ูุบุฐู ูู ุงูููุฉ", n:"ูุจุงุช ุงูุญุธุ ุจูุนูุด ูู ุงูููุฉ ุจุณ.", aliases:["ูุงูู ุจุงูุจู"] },
  "ูุฑูุชูู": { w:"ุจูุญุจ ุงูุนุทุด ุดููุฉ", s:"ุถูุก ููู ุนุดุงู ูููู", f:"NPK", n:"ูู ุงูุถูุก ูู ูุฑูู ุจูุจูู ุฃุฎุถุฑ ุจุณ.", aliases:["ูุฑูุชู"] },
  "ูุดุทุฉ": { w:"ูุนุชุฏู", s:"ุถูุก ุณุงุทุน", f:"NPK", n:"ูุฑููุง ูุฎุฑู ูุดูููุง ุฏูููุฑ ุฌุฏุงู.", aliases:[] },
  "ุจูุฌุง": { w:"ููุง ุชุฌู", s:"ุถู", f:"ูุชูุงุฒู", n:"ูุจุงุช ุตุจูุฑ ูุดููู ููุงุณูู.", aliases:[] },
  "ุฃุฌูููููุง": { w:"ูุนุชุฏู", s:"ุถู ุฃู ุถูุก ุฎููู", f:"NPK", n:"ูุฑููุง ูููู ููุถูุ ุจุชุณุชุญูู ููุฉ ุงูุถูุก.", aliases:["ุฃุฌูููููุฉ"] },
  "ููุฌูุฑ": { w:"ุจูุญุจ ุงูููุฉ ูุงูุฑุด", s:"ุถู ูุฑุทูุจุฉ", f:"ุณูุงุฏ ูุฑูู", n:"ุนุงูุฒ ูุนุงููุฉ ุฎุงุตุฉ ูุฑุทูุจุฉ ุนุงููุฉ.", aliases:["ุณุฑุฎุณ","Fern"] },

  // ุตุจุงุฑุงุช ูุนุตุงุฑูุงุช
  "ุตุจุงุฑ": { w:"ููุทุฉ ููุฉ ูู ุดูุฑ", s:"ุดูุณ ุฃู ุถูุก ููู", f:"ูุด ูุญุชุงุฌ", n:"ูู ุณููุชู ูุชูุฑ ุจูููุช (ุจูุนูู).", aliases:["ูุงูุชูุณ"] },
  "ุงููููุฑุง": { w:"ูู 3 ุฃุณุงุจูุน", s:"ุดูุณ ุฎูููุฉ", f:"ูุฑุฉ ูู ุงูุณูุฉ", n:"ุงูุฌู ุงููู ุฌูุงูุง ูููุฏ ููุจุดุฑุฉ ูุงูุดุนุฑ.", aliases:["ุฃููููุฑุง","ุฃููุฉ"] },
  "ุฅูุดููุฑูุง": { w:"ูููู ุฌุฏุงู", s:"ุดูุณ", f:"ูุงูุชูุณ", n:"ุดูููุง ุฒู ุงููุฑุฏุฉุ ุญุณุงุณุฉ ููููุฉ.", aliases:["Echeveria"] },
  "ูุงูุงูุดู": { w:"ููุง ุงูุชุฑุจุฉ ุชุญุฌุฑ", s:"ุถูุก ุดุจุงู", f:"NPK", n:"ุตุจุงุฑ ูุฒูุฑุ ูุฑุฏู ุฃููุงูู ูุชูุฑ.", aliases:["ูุงูุงูููุง"] },

  // ุฃุดุฌุงุฑ ูุดุฌูุฑุงุช ุฎุงุฑุฌูุฉ
  "ูููุณ ูุชุฏุง": { w:"ููู ูููู", s:"ุดูุณ", f:"NPK ุนุงูู ุงูููุชุฑูุฌูู", n:"ุจูุชุนูู ููู ุณูุฑ ุดุฌุฑู ููุชุงุฒ.", aliases:["ูููุณ ููุชูุฏุง"] },
  "ุชููููุง": { w:"ูุนุชุฏู", s:"ุดูุณ", f:"ูุชูุงุฒู", n:"ูุฑุฏูุง ุฃุตูุฑ ูุดูููุง ูุจูุฌ.", aliases:["ุชููููุง ุตูุฑุงุก"] },
  "ูุงูุชุงูุง": { w:"ูููู", s:"ุดูุณ ุญุงุฑูุฉ", f:"ูุด ุถุฑูุฑู", n:"ุจุชูู ูุฑุงุดุงุช ูุฃููุงููุง ุจุชุชุบูุฑ.", aliases:["ูุงูุชุงูุง ููููุฉ"] },
  "ููุฑููุฌุง": { w:"ูุนุชุฏู", s:"ุดูุณ", f:"ุนุถูู", n:"ุงูุดุฌุฑุฉ ุงููุนุฌุฒุฉุ ูุฑููุง ูููุฏ ุฌุฏุงู.", aliases:["ููุฑููุบุง"] },
  "ููููู": { w:"ููุชุธู (ุจููุฑู ุงูุนุทุด)", s:"ุดูุณ ูุงููุฉ", f:"ุญุฏูุฏ ูุนูุงุตุฑ ุตุบุฑู", n:"ุนุดุงู ุชุทุฑุญ ูุงุฒู ุดูุณ ูุชุณููุฏ.", aliases:["ููููู ุจูุฏู"] },
  "ุฒูุชูู": { w:"ูููู", s:"ุดูุณ", f:"ุนุถูู", n:"ุดุฌุฑุฉ ูุจุงุฑูุฉ ูุจุชุนูุด ุณููู.", aliases:["ุดุฌุฑุฉ ุฒูุชูู"] },

  // ุฅุถุงูุงุช ุฃุฎุฑู
  "ุณุฌุงุฏ": { w:"ูู ููููู", s:"ุดูุณ ุฎูููุฉ ุฃู ุถู ูููุฑ", f:"NPK", n:"ูุต ุงูุดูุฑูุฎ ุงูุฒูุฑู ุนุดุงู ุงููุฑู ููุถู ููู.", aliases:["ุณุจุงูุฏุฑ","ูููุฑูููุชูู"] },
  "ูุทููุฉ": { w:"ููู ูููู", s:"ุดูุณ", f:"NPK", n:"ูุฑุฏุฉ ุดุชููุฉ ุจุชุนูุด ูุญุฏ ุงูุฑุจูุน.", aliases:["ูุงุฑูุฌููุฏ","Marigold"] },
  "ูุฑููู": { w:"ูุนุชุฏู", s:"ุดูุณ", f:"ูุชูุงุฒู", n:"ุฑูุญุชู ุญููุฉ ูุดููู ุจูุฏู.", aliases:["Carnation"] },
  "ูุนูุงุน ุณุนูุฏู": { w:"ูุชูุฑ", s:"ูุตู ุธู", f:"ุนุถูู", n:"ูุฑูุชู ุตุบูุฑุฉ ูุฑูุญุชู ุฃููู ูู ุงูุจูุฏู.", aliases:["ูุนูุงุน ุตุบูุฑ"] },
  "ุฒุนุชุฑ ุจุฑู": { w:"ูููู", s:"ุดูุณ", f:"ูุง ููุฌุฏ", n:"ุจูุชุญูู ุงูุญุฑุงุฑุฉ ุฌุฏุงู.", aliases:["ุฒุนุชุฑ ุฌุจูู"] },
  "ุฃูุงุณูุง": { w:"ูููู", s:"ุดูุณ", f:"ูุง ููุฌุฏ", n:"ุดุฌุฑุฉ ุถู ููุชุงุฒุฉ.", aliases:["ุงูุงุณูุง"] },
  "ุจููุณูุงุชุง": { w:"ูุนุชุฏู", s:"ุถูุก ุณุงุทุน", f:"NPK", n:"ุจูุช ุงูููุตูุ ูุฑููุง ุจูุญูุฑ ูู ุงูุดุชุง.", aliases:["ุจูุช ุงูููุตู","ุจูููุณูุงุชูุง"] },
  "ุฏุฑุงุณููุง ููููู": { w:"ููุง ุชุฌู", s:"ุถูุก ูุชูุณุท", f:"ูุฑูู", n:"ููููุง ูููููู ูุจูุฌ.", aliases:["ุฏุฑุงุณููุง ููููู ูุงูู"] },
  "ูููุง": { w:"ูููู ุฌุฏุงู", s:"ุดูุณ ุฃู ุถู", f:"ูุชูุงุฒู", n:"ูุจุงุช ููู ุฌุฏุงู ูุณุนุฑู ุญููู.", aliases:["Yucca"] },
  "ุดูููุฑุง": { w:"ูุนุชุฏู", s:"ุถูุก ููู", f:"NPK", n:"ุดุฌูุฑุฉ ุฏุงุฎููุฉ ุดูููุง ูุซูู.", aliases:["ุดููููุฑุง","Schefflera"] }
};

/* =========================================
   2) Helpers
========================================= */
function $(id){ return document.getElementById(id); }
function escapeHTML(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function nl2br(s){ return escapeHTML(s).replace(/\n/g,"<br>"); }
function normalizeArabic(str){
  if(!str) return "";
  return str.toString().trim().toLowerCase()
    .replace(/[ุฅุฃุขุง]/g,"ุง")
    .replace(/ู/g,"ู")
    .replace(/ุฉ/g,"ู")
    .replace(/ุค/g,"ู")
    .replace(/ุฆ/g,"ู")
    .replace(/[ูููููููู]/g,"")
    .replace(/\s+/g," ");
}
function unsplash(query){
  // ุตูุฑ ุนุดูุงุฆูุฉ ุญุณุจ ุงููููุฉ (ุชุดุชุบู ุนูู GitHub Pages)
  return `https://source.unsplash.com/640x480/?${encodeURIComponent(query || "plant")}&sig=${Date.now()}`;
}
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* =========================================
   3) State
========================================= */
const state = {
  plantRaw: "ุนุงูุฉ",
  plantKey: null,
  plantObj: null,
  lastTopic: null,
  lastAdviceLong: null,
  photoSeed: 0,
  diag: { active:false, step:0, data:{} }
};

/* =========================================
   4) Plant selection (QR type)
========================================= */
function findPlantKeyByName(name){
  const n = normalizeArabic(name);
  if(!n) return null;

  // direct + aliases
  for(const [k,obj] of Object.entries(plantDB)){
    if(normalizeArabic(k) === n) return k;
    for(const al of (obj.aliases || [])){
      if(normalizeArabic(al) === n) return k;
    }
  }

  // contains match
  for(const [k,obj] of Object.entries(plantDB)){
    const kk = normalizeArabic(k);
    if(kk.includes(n) || n.includes(kk)) return k;
    for(const al of (obj.aliases || [])){
      const aa = normalizeArabic(al);
      if(aa && (aa.includes(n) || n.includes(aa))) return k;
    }
  }
  return null;
}

function setPlantFromURL(){
  const p = new URLSearchParams(location.search);
  const raw = (p.get("type") || "ุนุงูุฉ").replace(/_/g," ");
  state.plantRaw = raw;
  state.plantKey = findPlantKeyByName(raw);
  state.plantObj = state.plantKey ? plantDB[state.plantKey] : null;

  const display = state.plantKey || state.plantRaw || "ุนุงูุฉ";
  $("plantName").innerText = display;

  $("subtitle").innerText = "offline smart plant chat";
  $("plantDesc").innerText = state.plantObj
    ? "ุงุณุฃููู ุจุฃู ุตูุบุฉโฆ (ุฑู/ููุฑ/ุชุณููุฏ/ุฃุนุฑุงุถ/ุญุดุฑุงุช/ูุทุฑูุงุช/ุชุฑุจุฉ/ููู)."
    : "ูุด ูุงูู ุงูููุน ุฏูโฆ ุจุณ ูุฌุงูุจู ูุฅุฑุดุงุฏ ุนุงู ููุฒุฑุน.";

  updatePhoto(true);
}

/* =========================================
   5) UI: messages
========================================= */
function addMsg(role, html, actions=null){
  const div = document.createElement("div");
  div.className = "msg " + (role==="user" ? "user" : "bot");
  div.innerHTML = html;

  if(actions && role==="assistant"){
    const wrap = document.createElement("div");
    wrap.className = "mini-actions";
    actions.forEach(a=>{
      const b = document.createElement("button");
      b.textContent = a.label;
      b.onclick = ()=>{ $("input").value = a.fill; $("input").focus(); autoGrow(); };
      wrap.appendChild(b);
    });
    div.appendChild(wrap);
  }

  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function addTyping(){
  const div = document.createElement("div");
  div.className = "msg bot";
  div.innerHTML = `<span class="typing">ุจููุฑ <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>`;
  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
  return div;
}
function removeNode(n){ if(n && n.parentNode) n.parentNode.removeChild(n); }

/* =========================================
   6) Photos
========================================= */
function updatePhoto(initial=false){
  const display = state.plantKey || state.plantRaw || "plant";
  const q = display + " plant";
  $("plantImg").src = unsplash(q + (initial ? "" : "&x=" + (++state.photoSeed)));
  $("imgBadge").innerText = "ุตูุฑุฉ";
}
function nextPhoto(){
  updatePhoto(false);
  addMsg("assistant", "ุชูุงู ๐ฟ ุฏู ุตูุฑุฉ ุชุงููุฉโฆ ูู ุนุงูุฒ ููุงู ุฏูุณ ๐ผ๏ธ ุชุงูู.");
}

/* =========================================
   7) Quick buttons
========================================= */
const QUICK = ["ุงุฒููุ","ุฎูุงุตุฉ ุงูุนูุงูู","ุชุดุฎูุต","ุงูุชู ุงุณููุ","ุงุญุทูุง ูููุ","ุณูุงุฏ ุงููุ","ูุฑูู ุจูุตูุฑ","ูู ุญุดุฑุงุช","ุจูุน/ูุทุฑูุงุช","ูุฑููู ุตูุฑู"];
function renderQuick(){
  const row = $("quickRow");
  row.innerHTML = "";
  QUICK.forEach(t=>{
    const b = document.createElement("button");
    b.className = "q";
    b.textContent = t;
    b.onclick = ()=>{ $("input").value = t; $("input").focus(); autoGrow(); };
    row.appendChild(b);
  });
}

/* =========================================
   8) Knowledge packs (ุนูู offline ูุจูุฑ)
========================================= */
const KB = {
  // ููุงุนุฏ ุนุงูุฉ
  generalCare: () => [
    "ุญุท ุตุจุงุนู ูู ุงูุชุฑุจุฉ 3โ4 ุณู: ูู ูุงุดูุฉ ุงุณููุ ูู ุทุฑูุฉ ุงุณุชูู.",
    "ุงูุตุฑู ุฃูู ูู ุฃู ุญุงุฌุฉ: ูุงุฒู ูุชุญุงุช ุชุญุช + ูุชุณุจุด ููุฉ ูู ุงูุทุจู.",
    "ุดูุณ ุงูุถูุฑ ุจุชุญุฑูโฆ ุงูุฃูุถู ุดูุณ ุตุจุงุญ ุฃู ุถูุก ููู ุบูุฑ ูุจุงุดุฑ.",
    "ุงูุชุณููุฏ ูู ุงูุฑุจูุน/ุงูุตูู ุฃุญุณูโฆ ููู ุงูุดุชุงุก ูููู.",
    "ุงูุชุบููุฑ ุงูููุงุฌุฆ (ููุงู/ุฑู/ุชุณููุฏ) ูุนูู ุตุฏูุฉโฆ ุฎูู ุงูุชุบููุฑ ุชุฏุฑูุฌู."
  ],
  wateringDeep: () => `
**ุชูุงุตูู ุงูุฑู ุงูุตุญ (ุจุงูุฑุงุญุฉ ูุฏู):**
1) ุงุฎุชุจุฑ ุงูุชุฑุจุฉ ูุจู ุงูุฑู (ูุด ุจุงูุนูู).
2) ุงุณูู ูุญุฏ ูุง ุงูููุฉ ุชูุฒู ูู ุชุญุชโฆ ูุจุนุฏูุง ููุถูู ุงูุทุจู.
3) ูู ุงูุชุฑุจุฉ ุจุชูุนุฏ ูุจูููุฉ ูุชูุฑ โ ุฒููุฏ ุตุฑู (ุฑูู/ุจูุฑูุงูุช) ููููู ุงูุฑู.
4) ุนูุงูุงุช ุฒูุงุฏุฉ ุงูุฑู: ุงุตูุฑุงุฑ + ุทุฑุงูุฉ + ุฑูุญุฉ ุนูู.
5) ุนูุงูุงุช ููุฉ ุงูุฑู: ุฐุจูู + ูุฑู ูุงุดู/ููุฑูุด.
`,
  lightDeep: () => `
**ุชูุงุตูู ุงูููุฑ/ุงูุดูุณ:**
- ุดูุณ ูุจุงุดุฑุฉ: ุดูุณ ุชูุน ุนูู ุงููุฑู (ุฃูุถู ุตุจุงุญ).
- ุถูุก ุบูุฑ ูุจุงุดุฑ: ุงูููุงู ูููุฑ ุจุฏูู ุดูุณ ุนูู ุงููุฑู.
- ููุต ููุฑ: ุงุณุชุทุงูุฉ ุณุงู + ุฃูุฑุงู ุตุบูุฑุฉ + ููู ุจุทูุก.
- ุฒูุงุฏุฉ ุดูุณ: ุจูุน/ุญุฑูู ุจููุฉ ุฎุงุตุฉ ุนูู ุงูุญูุงู.
`,
  fertilizerDeep: () => `
**ุงูุชุณููุฏ ุจุฏูู ูุง ูุจููุธ ุงูุฏููุง:**
- NPK ูุชูุงุฒู (ูุซูุงู 20-20-20) ุฎููู ูู 3-4 ุฃุณุงุจูุน ูู ุงูููุณู.
- ููุชุฒููุฑ: ุฒููุฏ ุจูุชุงุณููู (K) ุดููุฉ.
- ูู ุฃุทุฑุงู ุงุชุญุฑูุช ุจุนุฏ ุชุณููุฏ: ุบุงูุจุงู ุฒูุงุฏุฉ โ ุงุบุณู ุงูุชุฑุจุฉ ุจุฑู ุบุฒูุฑ ูุฑุฉ/ูุฑุชูู ูููู ุฃุณุจูุนูู.
`,
  soilDeep: () => `
**ุงูุชุฑุจุฉ ุงูุตุญ:**
- ูุงุนุฏุฉ ุฐูุจูุฉ: ุฎูููุฉ + ูุณุงููุฉ + ุชุตุฑูู.
- ุฎูุทุงุช ุจุณูุทุฉ:
  โข ุฏุงุฎูู: ุจูุชููุณ/ููุจูุณุช + ุจูุฑูุงูุช/ุฑูู ุฎุดู.
  โข ุตุจุงุฑุงุช: ุฒููุฏ ุงูุฑูู/ุงูุจูุฑูุงูุช ููููู ุงูุนุถูู.
`,
  pestsPlan: () => `
**ูู ูู ุญุดุฑุงุช (ุฎุทุฉ ุฅููุงุฐ ุขููุฉ):**
1) ุงุนุฒู ุงููุจุงุช ุนู ุงูุจุงูู.
2) ุงูุณุญ ุงููุฑู ุจููุฉ + ุตุงุจูู ูุทูู/ุตุงุจูู ุจูุชุงุณููู ุซู ุงุดุทู.
3) ุฑุด ุฒูุช ููู (ุฅู ูุฌุฏ) ูู 5-7 ุฃูุงู (3 ูุฑุงุช).
4) ูุต ุงููุฑู ุงููุชุถุฑุฑ ุฌุฏูุง.
5) ุงูุญุต ุธูุฑ ุงููุฑู (ููุงู ุจุชุณุชุฎุจู ุงูุญุดุฑุงุช).
`,
  fungusPlan: () => `
**ูู ูุทุฑูุงุช/ุจูุน:**
1) ูููู ุฑุด ุงูููุฉ ุนูู ุงููุฑู + ุฒููุฏ ุชูููุฉ.
2) ุงุณูู ุงูุตุจุญ ูุด ุจููู.
3) ุดูู ุงูุฃูุฑุงู ุงููุตุงุจุฉ.
4) ูู ุจูุน ุจุชุฒูุฏ: ุงุณุชุฎุฏู ูุจูุฏ ูุทุฑู ููุงุณุจ (ุจุญุฐุฑ) ุฃู ุงุณุชุดุงุฑุฉ ูุฎุชุต.
`,
  repotPlan: () => `
**ููู/ุชุฏููุฑ ุงูุฃุตูุต:**
- ุงููู ููุง ุงูุฌุฐูุฑ ุชููุฃ ุงูุฃุตูุต ุฃู ุงูููุฉ ุชุนุฏูู ุจุณุฑุนุฉ.
- ูุจุฑ ุงูููุงุณ ุฏุฑุฌุฉ ูุงุญุฏุฉ ููุท.
- ุจุนุฏ ุงูููู: ุงุณูู ูุฑุฉ ูููุณ ูุจูุงุด ุชุณููุฏ 2 ุฃุณุจูุน.
`,
  pruningPlan: () => `
**ุงูุชูููู:**
- ูุต ุงูููู = ุชูุฑูุน ููุซุงูุฉ.
- ุดูู ุงููุฑู ุงูุฏุจูุงู ุฃูู ุจุฃูู.
- ููุต ูุธููโฆ ููุต ููู ุนูุฏุฉ/ุจุฑุนู.
`,
  propagatePlan: () => `
**ุงูุฅูุซุงุฑ (ุณุฑูุน):**
- ุฃุนุดุงุจ: ุนูู ุฃู ุจุฐูุฑ ุญุณุจ ุงูููุน.
- ูุชุณููุงุช: ุนููุฉ ุจุนูุฏุฉ ูู ููุฉ/ุชุฑุจุฉ.
- ุนุตุงุฑูุงุช: ูุฑูุฉ/ุฎููุฉ ุจุนุฏ ูุง ููุงู ุงููุทุน ููุดู.
`,
  askClarifiers: () => [
    "ูู ุฏุงุฎู ุงูุจูุช ููุง ุจุฑูุ",
    "ุงูููุฑ ุนูุฏูุง ุดูุณ ูุจุงุดุฑุฉ ููุง ุถูุก ุจุณุ",
    "ุจุชุณูู ูู ูุฏ ุฅูู ุชูุฑูุจุงูุ",
    "ุญุฌู ุงูุฃุตูุต ูุฏ ุฅููุ ูููู ุตุฑู ุชุญุชุ"
  ]
};

function plantSummary(name){
  const p = state.plantObj;
  if(!p){
    return `**ุฎูุงุตุฉ ุนุงูุฉ ูุฃู ุฒุฑุนุฉ ๐ฟ**
โข ๐ง ุฑู: ุงุณูู ููุง ุฃูู 3 ุณู ููุดููุง
โข โ๏ธ ููุฑ: ุถูุก ููู ุบูุฑ ูุจุงุดุฑ (ูุดูุณ ุตุจุงุญ ูู ูููุน)
โข ๐ ุชุณููุฏ: ูุชูุงุฒู ุฎููู ูู ุงูููุณู
โข ๐ชด ุตุฑู: ูุชุญุงุช ุชุญุช + ูุชุณุจุด ููุฉ ุฑุงูุฏุฉ`;
  }
  return `**ุฎูุงุตุฉ ุนูุงูุฉ ${name} ๐ฟ**
โข ๐ง ุงูุฑู: ${p.w}
โข โ๏ธ ุงูููุงู: ${p.s}
โข ๐ ุงูุชุณููุฏ: ${p.f}
โข ๐ก ูุตูุญุฉ: ${p.n}`;
}

/* =========================================
   9) Intent detection (ูููู ููุงู ูุชูุฑ)
========================================= */
const INT = {
  greet: /(ุงุฒูู|ุงุฒู|ุนุงูู ุงูู|ุงููุง|ููุง|ุณูุงู|ุงูุณูุงู ุนูููู|ุตุจุงุญ|ูุณุงุก|ูุงู|hello|hi)/,
  thanks: /(ุดูุฑุง|ูุชุดูุฑ|ุชุณูู|ุญุจูุจู|ุงูุนูู|ููุฑุณู|merci|thx)/,
  who: /(ููู ุงูุช|ููู ุงูุชู|ุงุณูู ุงูู|ุจุชุนููู ุงูู|ุงูุช ุงูู)/,
  help: /(ุงูุงูุฑ|ูุณุงุนุฏู|ุชุนูููุงุช|help)/,
  list: /(ุงููุงุน|ุงูุงููุงุน|ูุงุฆูู|ุงููุงุฆูุฉ|ุนูุฏู ุงูู|list)/,
  summary: /(ุฎูุงุตู|ููุฎุต|ุฒุจุฏุฉ|ูุฎุชุตุฑ|ุฎูุงุตุฉ ุงูุนูุงูู|ุฎูุงุตุฉ ุงูุนูุงูุฉ)/,
  diagnose: /(ุชุดุฎูุต|ุดุฎุต|ุชุดุฎูุต ุณุฑูุน|ุงุนูู ุชุดุฎูุต)/,
  explain: /(ุงุดุฑุญ|ูุถุญ|ุชูุงุตูู|ุงูุชุฑ|ูุฒูุฏ|ููู|ุงุฒุงู)/,

  watering: /(ุฑู|ุงุณูู|ุงุณูููุง|ููู|ููุงู|ุนุทุด|ุณูุงูุฉ|ุงูุชู ุงุณูู)/,
  light: /(ุดูุณ|ููุฑ|ุถูุก|ููุงู|ููู ุงุญุทูุง|ุงุญุทูุง ููู|ุดุจุงู|ุจููููู|ุฏุงุฎู|ุจุฑุง)/,
  fertilize: /(ุณูุงุฏ|ุชุณููุฏ|npk|ุญุฏูุฏ|ุจูุชุงุณููู|ุนูุงุตุฑ|ุบุฐุง|ุงูู)/,
  soil: /(ุชุฑุจู|ุจูุชููุณ|ุฑูู|ุจูุฑูุงูุช|ุตุฑู|ุชุตุฑูู|ููุจูุณุช)/,
  repot: /(ุงุตูุต|ูุตุฑูู|ููู|ุชุฏููุฑ|ุชุบููุฑ ุชุฑุจุฉ|ุฌุฐูุฑ)/,
  pruning: /(ุชูููู|ูุต|ุงูุต|ุงูุฑุน|ุชูุฑูุน)/,
  propagate: /(ุงูุซุงุฑ|ุนููู|ุจุฐูุฑ|ุฎููุงุช|ุชูุตูุต)/,

  pests: /(ุญุดุฑุงุช|ูู|ุจู|ุจู ุฏูููู|ุฐุจุงุจุฉ|ุจูุถุงุก|ุนููุจูุช|ุณูุณ|ููู)/,
  fungus: /(ูุทุฑูุงุช|ุนูู|ุจูุน|ุณูุงุฏ|ุจูุงุถ ุฏูููู|ุตุฏุฃ)/,
  yellow: /(ุงุตูุฑ|ุงุตูุฑุงุฑ|ูุฑูู ุจูุตูุฑ)/,
  wilt: /(ุฐุจู|ุฐุจูู|ูุชูุฏู|ูุงูุน)/,
  burn: /(ุญุฑูู|ุญุฑู|ุจูู|ุงุทุฑุงู ุจูู|ุจูุน ุจูู)/,

  price: /(ุณุนุฑ|ูุงู|ุจูุงู|ุชูู|ุจูู)/,
  image: /(ุตูุฑู|ุตูุฑ|ูุฑููู|ุดูููุง|photo|picture)/,
  imageMore: /(ุตูุฑู ุชุงููู|ุตูุฑุฉ ุชุงููุฉ|ุตูุฑู ููุงู|ุตูุฑุฉ ููุงู|next)/,
  change: /^(ุบูุฑ|ุจุฏู|ุญูู|ุฎูู)\s*(ุงููุจุงุช|ุงูุฒุฑุนู)?\s*(ู|ุงูู|:)\s*(.+)$/
};

function extractPlantMention(text){
  const t = normalizeArabic(text);
  if(!t) return null;

  // ูู ุงูุฌููุฉ ูุตูุฑุฉ ุบุงูุจุงู ุงุณู ุฒุฑุนุฉ
  const maybe = findPlantKeyByName(t);
  if(maybe) return maybe;

  // ูู ุฐูุฑ ุงุณู ุฒุฑุนุฉ ุฏุงุฎู ุงูููุงู
  for(const [k,obj] of Object.entries(plantDB)){
    const kk = normalizeArabic(k);
    if(kk && t.includes(kk)) return k;
    for(const al of (obj.aliases || [])){
      const aa = normalizeArabic(al);
      if(aa && t.includes(aa)) return k;
    }
  }
  return null;
}

/* =========================================
   10) Diagnosis wizard (ุชุดุฎูุต ุฎุทูุฉ ุจุฎุทูุฉ)
========================================= */
function startDiagnosis(){
  state.diag.active = true;
  state.diag.step = 1;
  state.diag.data = {};
  const q = "ุชูุงู โ ููุนูู ุชุดุฎูุต ุณุฑูุนโฆ\n\n**1) ุงูุฒุฑุนุฉ ุฏุงุฎู ุงูุจูุช ููุง ุจุฑูุ**";
  addMsg("assistant", nl2br(q), [
    {label:"ุฏุงุฎู", fill:"ุฏุงุฎู"},
    {label:"ุจุฑู/ุจููููุฉ", fill:"ุจุฑู"},
    {label:"ูุด ูุชุฃูุฏ", fill:"ูุด ูุชุฃูุฏ"}
  ]);
}
function continueDiagnosis(userText){
  const t = normalizeArabic(userText);

  if(state.diag.step === 1){
    state.diag.data.place = t.includes("ุฏุงุฎู") ? "ุฏุงุฎู" : (t.includes("ุจุฑู") || t.includes("ุจุฑุง") ? "ุจุฑู" : "ูุด ูุชุฃูุฏ");
    state.diag.step = 2;
    addMsg("assistant", nl2br("**2) ุงูููุฑ ุนูุฏูุง ุฅููุ**"), [
      {label:"ุดูุณ ูุจุงุดุฑุฉ", fill:"ุดูุณ ูุจุงุดุฑุฉ"},
      {label:"ุถูุก ููู ุจุฏูู ุดูุณ", fill:"ุถูุก ููู ุจุฏูู ุดูุณ"},
      {label:"ุฅุถุงุกุฉ ุถุนููุฉ", fill:"ุฅุถุงุกุฉ ุถุนููุฉ"}
    ]);
    return;
  }

  if(state.diag.step === 2){
    if(t.includes("ุดูุณ")) state.diag.data.light = "ุดูุณ ูุจุงุดุฑุฉ";
    else if(t.includes("ุถุนูู")) state.diag.data.light = "ุฅุถุงุกุฉ ุถุนููุฉ";
    else state.diag.data.light = "ุถูุก ููู ุจุฏูู ุดูุณ";
    state.diag.step = 3;
    addMsg("assistant", nl2br("**3) ุจุชุณูู ูู ูุฏ ุฅูู ุชูุฑูุจุงูุ**"), [
      {label:"ูู ููู", fill:"ูู ููู"},
      {label:"ููู ูููู", fill:"ููู ูููู"},
      {label:"ูู 3-5 ุฃูุงู", fill:"ูู 3-5 ุฃูุงู"},
      {label:"ุฃุณุจูุน ุฃู ุฃูุชุฑ", fill:"ุฃุณุจูุน ุฃู ุฃูุชุฑ"}
    ]);
    return;
  }

  if(state.diag.step === 3){
    let w = "ูุด ูุงุถุญ";
    if(t.includes("ูู ููู")) w = "ูู ููู";
    else if(t.includes("ููู ูููู")) w = "ููู ูููู";
    else if(t.includes("3") || t.includes("5")) w = "ูู 3-5 ุฃูุงู";
    else if(t.includes("ุฃุณุจูุน") || t.includes("7")) w = "ุฃุณุจูุน ุฃู ุฃูุชุฑ";
    state.diag.data.watering = w;
    state.diag.step = 4;
    addMsg("assistant", nl2br("**4) ุงููุดููุฉ ุงูุฃุณุงุณูุฉ ุฅููุ**"), [
      {label:"ุงุตูุฑุงุฑ", fill:"ุงุตูุฑุงุฑ"},
      {label:"ุฐุจูู", fill:"ุฐุจูู"},
      {label:"ุจูุน/ูุทุฑูุงุช", fill:"ุจูุน"},
      {label:"ุญุดุฑุงุช", fill:"ุญุดุฑุงุช"},
      {label:"ูุด ุนุงุฑู", fill:"ูุด ุนุงุฑู"}
    ]);
    return;
  }

  if(state.diag.step === 4){
    let problem = "ูุด ุนุงุฑู";
    if(t.includes("ุงุตูุฑ")) problem = "ุงุตูุฑุงุฑ";
    else if(t.includes("ุฐุจู") || t.includes("ูุชูุฏู")) problem = "ุฐุจูู";
    else if(t.includes("ุจูุน") || t.includes("ูุทุฑ")) problem = "ุจูุน/ูุทุฑูุงุช";
    else if(t.includes("ุญุดุฑ")) problem = "ุญุดุฑุงุช";
    state.diag.data.problem = problem;
    state.diag.active = false;

    const report = buildDiagnosisReport();
    state.lastTopic = "diagnosis";
    state.lastAdviceLong = report.long;
    addMsg("assistant", nl2br(report.short), report.actions);
    return;
  }
}

function buildDiagnosisReport(){
  const name = state.plantKey || state.plantRaw || "ุงููุจุงุช";
  const d = state.diag.data;

  // ุงุณุชูุชุงุฌุงุช ุจุณูุทุฉ
  let suspects = [];
  if(d.problem === "ุงุตูุฑุงุฑ"){
    if(d.watering === "ูู ููู") suspects.push("ุฒูุงุฏุฉ ุฑู (ุฃุดูุฑ ุณุจุจ ููุงุตูุฑุงุฑ)");
    if(d.light === "ุฅุถุงุกุฉ ุถุนููุฉ") suspects.push("ููุต ููุฑ");
    suspects.push("ููุต ุชุบุฐูุฉ ูู ูููุด ุชุณููุฏ ูุชุฑุฉ ุทูููุฉ");
  }
  if(d.problem === "ุฐุจูู"){
    if(d.watering === "ุฃุณุจูุน ุฃู ุฃูุชุฑ") suspects.push("ููุฉ ุฑู / ุนุทุด");
    if(d.watering === "ูู ููู") suspects.push("ุชุนูู ุฌุฐูุฑ ุจุณุจุจ ุฒูุงุฏุฉ ุฑู");
    suspects.push("ุตุฏูุฉ ููู ููุงู ุฃู ุญุฑุงุฑุฉ/ุจุฑุฏ");
  }
  if(d.problem === "ุจูุน/ูุทุฑูุงุช"){
    suspects.push("ุฑุทูุจุฉ ุนุงููุฉ + ุชูููุฉ ุถุนููุฉ");
    suspects.push("ุฑู ูุชุฃุฎุฑ ุจุงูููู ุฃู ุฑุด ููุฉ ุนูู ุงููุฑู");
  }
  if(d.problem === "ุญุดุฑุงุช"){
    suspects.push("ุฅุตุงุจุฉ ูู/ุฐุจุงุจุฉ ุจูุถุงุก/ุจู ุฏูููู ุบุงูุจุงู");
    suspects.push("ุถุนู ูุจุงุช ุจุณุจุจ ููุฑ/ุฑู ุบูุฑ ููุงุณุจ");
  }
  if(!suspects.length) suspects = ["ูุญุชุงุฌ ุชูุงุตูู ุฃูุชุฑ ุนุดุงู ุงูุชุดุฎูุต ูุจูู ุฃุฏู"];

  const steps = [];
  steps.push(`**ููุฎุต ุญุงูุชู:** ${d.place || "-"} / ${d.light || "-"} / ุฑู: ${d.watering || "-"}`);
  steps.push(`**ุฃูุฑุจ ุฃุณุจุงุจ ูุญุชููุฉ:**\n- ${suspects.join("\n- ")}`);

  // ุฎุทูุงุช ุนูุงุฌ ุญุณุจ ุงููุดููุฉ
  let fix = "";
  if(d.problem === "ุงุตูุฑุงุฑ"){
    fix = `**ุฎุทุฉ ุนูุงุฌ ููุงุตูุฑุงุฑ:**
1) ูู ุงูุชุฑุจุฉ ุทุฑูุฉ/ูุจูููุฉ: ููู ุฑู ูููููโ4 ุฃูุงู ูุฎููููุง ุชูุดู.
2) ุฒููุฏ ุงูููุฑ ุชุฏุฑูุฌููุง (ุดูุณ ุตุจุงุญ ุฃู ุถูุก ููู ุบูุฑ ูุจุงุดุฑ).
3) ุชุฃูุฏ ูู ุงูุตุฑู: ูุชุญุงุช ุชุญุช + ูุชุณูุจุด ููุฉ ูู ุงูุทุจู.
4) ุจุนุฏ ูุง ุชุณุชูุฑ: ุณูุงุฏ ูุชูุงุฒู ุฎููู (ูู ุงูููุณู) ูุฑุฉ ูู 3-4 ุฃุณุงุจูุน.`;
  } else if(d.problem === "ุฐุจูู"){
    fix = `**ุฎุทุฉ ุนูุงุฌ ููุฐุจูู:**
1) ุงุฎุชุจุฑ ุงูุชุฑุจุฉ:
   - ูุงุดูุฉ: ุงุณูู ูููุณ ูุญุฏ ูุง ุงูููุฉ ุชูุฒู ูู ุชุญุช.
   - ุทุฑูุฉ/ุจุชุนูู: ููู ุฑู ูุญุณูู ุตุฑู/ุจุฏูู ุชุฑุจุฉ ูู ูุงุฒู.
2) ุงุจุนุฏ ุนู ุดูุณ ุงูุถูุฑ ุงูุญุงุฑูุฉ.
3) ูุต ุงููุฑู/ุงูุฃุฌุฒุงุก ุงูููุชุฉ.`;
  } else if(d.problem === "ุจูุน/ูุทุฑูุงุช"){
    fix = `**ุฎุทุฉ ุนูุงุฌ ููุจูุน/ุงููุทุฑูุงุช:**
1) ุดูู ุงูุฃูุฑุงู ุงููุตุงุจุฉ.
2) ุฒููุฏ ุชูููุฉ + ุงุณูู ุงูุตุจุญ.
3) ุจูุงุด ุฑุด ุนูู ุงููุฑู.
4) ูู ุจุชุฒูุฏ: ุงุณุชุดุงุฑุฉ ูุฎุชุต/ูุจูุฏ ูุทุฑู ููุงุณุจ ุจุญุฐุฑ.`;
  } else if(d.problem === "ุญุดุฑุงุช"){
    fix = `**ุฎุทุฉ ุนูุงุฌ ููุญุดุฑุงุช:**
1) ุงุนุฒู ุงููุจุงุช.
2) ุงูุณุญ ุงููุฑู ุจุตุงุจูู ูุทูู/ุจูุชุงุณููู ุซู ุงุดุทู.
3) ุฑุด ุฒูุช ููู (ุฅู ูุฌุฏ) ูู 5-7 ุฃูุงู 3 ูุฑุงุช.
4) ุงูุญุต ุธูุฑ ุงููุฑู ุจุงุณุชูุฑุงุฑ.`;
  } else {
    fix = `**ุนุดุงู ุฃุฏู ุงูุชุดุฎูุต:**
ููููู: ูุฑู ุจูุตูุฑ ููุง ุจููุนุ ููู ุจูุนุ ููู ุญุดุฑุงุชุ ุงูุชุฑุจุฉ ุฑูุญุชูุง ูุญุดุฉุ`;
  }
  steps.push(fix);

  const short = `ุชูุงู ูุง ุจุทู โ\n${name}\n\n${steps.join("\n\n")}\n\n(ูู ุนุงูุฒ ุชูุตูู ุฃูุชุฑ ููู: ุงุดุฑุญูู)`;
  const long = short + "\n\n" + KB.wateringDeep() + "\n" + KB.lightDeep();

  return {
    short,
    long,
    actions: [
      {label:"ุงุดุฑุญูู", fill:"ุงุดุฑุญูู"},
      {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
      {label:"ุฑู", fill:"ุงูุชู ุงุณููุ"},
      {label:"ููุฑ", fill:"ุงุญุทูุง ูููุ"}
    ]
  };
}

/* =========================================
   11) Reply builder (ุฑุฏูุฏ ูุชููุนุฉ + ุจุฏุงุฆู)
========================================= */
function replyGreeting(name){
  const rules = rand([
    [
      "ูุชุบุฑูููุดโฆ ุงูุฑู ุงูุฒูุงุฏุฉ ุจูุจููุธ ุงูุชุฑ ูู ุงูููุฉ.",
      "ุงุฏููู ููุฑ ููุงุณุจโฆ ุดูุณ ุงูุถูุฑ ุจุชุชุญุฑููู.",
      "ุฎููู ุงูุฃุตูุต ููู ุตุฑูโฆ ูุฅูุง ุงูุฌุฐูุฑ ุชุฎุชูู."
    ],
    [
      "ุงุณูููู ููุง ุงูุชุฑุจุฉ ุชูุดู ุดููุฉ (ูุด ูู ุดููุฉ).",
      "ุญุทูู ูู ุถูุก ูููโฆ ููู ุดูุณ ูุจูู ุตุจุงุญ.",
      "ุณูุงุฏ ุฎููู ูู ุงูููุณูโฆ ูุจูุงุด ุฒูุงุฏุฉ."
    ],
    [
      "ุซุจูุชูู ูู ููุงู ูููุฑ ููุชููู.",
      "ุงุฎุชุจุฑ ุงูุชุฑุจุฉ ูุจู ุงูุฑู (ุตุจุงุนู ุฃุญุณู ูู ุนููู).",
      "ุดูู ุงููุฑู ุงูุฏุจูุงู ุฃูู ุจุฃูู."
    ]
  ]);

  const msg = `ุงูุญูุฏููู ุชูุงู ๐ฟ๐\nุฃูุง **${name}**โฆ ูุนูุดุงู ุฃูุถู ูููุณุฉ ุงุนูู ุฏูู:\n1) ${rules[0]}\n2) ${rules[1]}\n3) ${rules[2]}\n\nูููู ุชุญุจ: **ุฎูุงุตุฉ ุงูุนูุงูู** ููุง **ุชุดุฎูุต** ููุง ุนูุฏู ูุดููุฉ ูุนููุฉุ`;
  state.lastTopic = "greet";
  state.lastAdviceLong = msg + "\n\n" + KB.generalCare().map(x=>"- "+x).join("\n");
  return { text: msg, actions:[
    {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
    {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"},
    {label:"ุงุตูุฑุงุฑ", fill:"ูุฑูู ุจูุตูุฑ"},
    {label:"ุญุดุฑุงุช", fill:"ูู ุญุดุฑุงุช"}
  ]};
}

function replyPrice(){
  const msg = `ุงูุฃุณุนุงุฑ ุจุชุชุบูุฑ ุญุณุจ **ุงูุญุฌู** ู**ุงูููุณู** ๐\nุดุฑููุง ูู ุงููุดุชู ููุงุจุชู ูุญูุฏ ููุธุจุทูุงูู ุนูู ุญุณุจ ุงููู ููุงุณุจู ๐`;
  return { text: msg, actions:[
    {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
    {label:"ุงูููุน ุงูููุงุณุจ", fill:"ุนุงูุฒ ุฒุฑุนุฉ ุฏุงุฎู ุงูุจูุช"}
  ]};
}

function replyWho(name){
  const msg = `ุฃูุง **ask my plant** ๐ฟ\nุจุณ ุจุชููู ูุนุงู ุจุตูุช ุฒุฑุนุชู: **${name}** ๐\nุงุณุฃููู ุจุฃู ุตูุบุฉ: ุฑู/ููุฑ/ุชุณููุฏ/ูุดููุฉโฆ ูุฃูุง ูุฑุฏ ุนููู.`;
  return { text: msg, actions:[
    {label:"ุงูุฃูุงูุฑ", fill:"ุงูุงูุฑ"},
    {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
    {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
  ]};
}

function replyHelp(){
  const msg =
`**ุงูุฃูุงูุฑ ุงููู ุจููููุง (ุชูุฑูุจุงู ุฃู ุตูุบุฉ):**
โข ุงุฒูู / ุตุจุงุญ ุงูุฎูุฑ / ุณูุงู
โข ุงูุชู ุงุณููุ / ุฑู
โข ุงุญุทูุง ูููุ / ููุฑ / ุดูุณ
โข ุณูุงุฏ ุงููุ / ุชุณููุฏ / ุญุฏูุฏ
โข ูุฑูู ุจูุตูุฑ / ุฐุงุจู / ุจูุน ุจููุฉ
โข ุญุดุฑุงุช / ูุทุฑูุงุช
โข ุชุฑุจุฉ / ุตุฑู / ููู ุงุตูุต
โข ุชุดุฎูุต (ุณุฑูุน ุฎุทูุฉ ุจุฎุทูุฉ)
โข ุงูุชุจ ุงุณู ุฒุฑุนุฉ ููุญุฏู ุนุดุงู ุฃุญูููู ุนูููุง (ูุซูุงู: ุฑูุญุงู)

(ููู ูุด ูุงูู ุณุคุงููโฆ ูุณุฃูู ูุงู ุณุคุงู ูุฃุดุฎุต ูุนุงู)`;
  return { text: msg, actions:[
    {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"},
    {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
    {label:"ูุฑููู ุตูุฑู", fill:"ูุฑููู ุตูุฑู"}
  ]};
}

function replyTopic(name, topic){
  const p = state.plantObj;
  let msg = "";

  if(topic === "summary"){
    msg = plantSummary(name);
    state.lastTopic = "summary";
    state.lastAdviceLong = msg + "\n\n" + KB.wateringDeep() + "\n" + KB.lightDeep();
    return { text: msg, actions:[
      {label:"ุงุดุฑุญูู", fill:"ุงุดุฑุญูู"},
      {label:"ุฑู", fill:"ุงูุชู ุงุณููุ"},
      {label:"ููุฑ", fill:"ุงุญุทูุง ูููุ"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "watering"){
    msg = p ? `๐ง **ุจุงููุณุจุฉ ูู ${name}:** ${p.w}\n\n` : `๐ง **ุฑู ุนุงู:** ุงุณูู ููุง ุฃูู 3-4 ุณู ููุดููุง.\n\n`;
    msg += KB.wateringDeep();
    state.lastTopic = "watering";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ุฃุนุฑุงุถ ุฒูุงุฏุฉ ุงูุฑู", fill:"ูุฑูู ุจูุตูุฑ"},
      {label:"ุชุฑุจุฉ ูุตุฑู", fill:"ุชุฑุจุฉ/ุตุฑู"},
      {label:"ุฎูุงุตุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "light"){
    msg = p ? `โ๏ธ **ุจุงููุณุจุฉ ูู ${name}:** ${p.s}\n\n` : `โ๏ธ **ููุฑ ุนุงู:** ุถูุก ููู ุบูุฑ ูุจุงุดุฑ + ุดูุณ ุตุจุงุญ ูู ูููุน.\n\n`;
    msg += KB.lightDeep();
    state.lastTopic = "light";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ุจูุน/ุญุฑูู", fill:"ุญุฑูู ุงู ุจูุน ุจูู"},
      {label:"ุฎูุงุตุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "fertilize"){
    msg = p ? `๐ **ุจุงููุณุจุฉ ูู ${name}:** ${p.f}\n\n` : `๐ **ุชุณููุฏ ุนุงู:** ูุชูุงุฒู ุฎููู ูู ุงูููุณู.\n\n`;
    msg += KB.fertilizerDeep();
    state.lastTopic = "fertilize";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ุฎูุงุตุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
      {label:"ุงุดุฑุญูู", fill:"ุงุดุฑุญูู"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "soil"){
    msg = `๐ชด **ุงูุชุฑุจุฉ ูุงูุตุฑู:**\n\n${KB.soilDeep()}`;
    state.lastTopic = "soil";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ููู ุงุตูุต", fill:"ููู ุงุตูุต"},
      {label:"ุฑู", fill:"ุงูุชู ุงุณููุ"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "repot"){
    msg = `๐ชด **ููู ุงูุฃุตูุต:**\n\n${KB.repotPlan()}`;
    state.lastTopic = "repot";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ุชุฑุจุฉ", fill:"ุชุฑุจุฉ/ุตุฑู"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "pests"){
    msg = `๐ **ุงูุญุดุฑุงุช:**\n\n${KB.pestsPlan()}`;
    state.lastTopic = "pests";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ุงุดุฑุญูู", fill:"ุงุดุฑุญูู"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "fungus"){
    msg = `๐ **ุงููุทุฑูุงุช/ุงูุจูุน:**\n\n${KB.fungusPlan()}`;
    state.lastTopic = "fungus";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ุชูููุฉ/ููุฑ", fill:"ููุฑ"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "pruning"){
    msg = `โ๏ธ **ุงูุชูููู:**\n\n${KB.pruningPlan()}`;
    state.lastTopic = "pruning";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ุงูุซุงุฑ", fill:"ุงูุซุงุฑ"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  if(topic === "propagate"){
    msg = `๐ฑ **ุงูุฅูุซุงุฑ:**\n\n${KB.propagatePlan()}`;
    state.lastTopic = "propagate";
    state.lastAdviceLong = msg;
    return { text: msg, actions:[
      {label:"ุชุฑุจุฉ", fill:"ุชุฑุจุฉ/ุตุฑู"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  return null;
}

function replySymptoms(text){
  const t = normalizeArabic(text);
  const name = state.plantKey || state.plantRaw || "ุฒุฑุนุฉ";

  // ุงุตูุฑุงุฑ
  if(INT.yellow.test(t)){
    const msg =
`ูุงููู โ ูู **ุงููุฑู ุจูุตูุฑ**โฆ ุฃุดูุฑ ุงูุฃุณุจุงุจ:
1) **ุฒูุงุฏุฉ ุฑู** (ุงูุฃูุซุฑ ุงูุชุดุงุฑุงู) โ ุงูุชุฑุจุฉ ุจุชูุถู ูุจูููุฉ.
2) **ููุต ููุฑ** โ ุงููุจุงุช ูุด ูุงูู ุทุงูุฉ.
3) **ููุต ุชุบุฐูุฉ** โ ูู ูููุด ุชุณููุฏ ูุชุฑุฉ ุทูููุฉ.

**ุญู ุณุฑูุน:**
- ุงุฎุชุจุฑ ุงูุชุฑุจุฉ: ูู ุทุฑูุฉโฆ ููู ุฑู ูุงู ููู.
- ุฒููุฏ ููุฑ ุชุฏุฑูุฌู (ุถูุก ููู/ุดูุณ ุตุจุงุญ).
- ุชุฃูุฏ ูู ุงูุตุฑู (ูุชุญุงุช ุชุญุช + ูููุด ููุฉ ุฑุงูุฏุฉ).

ููููู: ุจุชุณูู ูู ูุฏ ุฅููุ ูุฏุงุฎู ููุง ุจุฑูุ`;
    state.lastTopic = "yellow";
    state.lastAdviceLong = msg + "\n\n" + KB.wateringDeep();
    return { text: msg, actions:[
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"},
      {label:"ุฑู", fill:"ุงูุชู ุงุณููุ"},
      {label:"ููุฑ", fill:"ุงุญุทูุง ูููุ"},
      {label:"ุชุฑุจุฉ/ุตุฑู", fill:"ุชุฑุจุฉ/ุตุฑู"}
    ]};
  }

  // ุฐุจูู
  if(INT.wilt.test(t)){
    const msg =
`ุชูุงู โ ูู **ุฐุจูู/ูุชูุฏูุฉ**โฆ ุงุนูู ุงุฎุชุจุงุฑ ุณุฑูุน:
- ูู ุงูุชุฑุจุฉ **ูุงุดูุฉ**: ุงุณูู ูููุณ ูุญุฏ ูุง ุงูููุฉ ุชูุฒู ูู ุชุญุช.
- ูู ุงูุชุฑุจุฉ **ุทุฑูุฉ/ูุจูููุฉ**: ุบุงูุจุงู **ุฒูุงุฏุฉ ุฑู/ุชุนูู** โ ููู ุฑู ูุญุณูู ุงูุตุฑู.

**ูุตุงูุญ ุณุฑูุนุฉ:**
- ุงุจุนุฏูุง ุนู ุดูุณ ุงูุถูุฑ.
- ูุต ุงููุฑู ุงูููุช.
- ูู ูู ุฑูุญุฉ ุนูู ูู ุงูุชุฑุจุฉโฆ ููููู ููุฑุงู.`;
    state.lastTopic = "wilt";
    state.lastAdviceLong = msg + "\n\n" + KB.repotPlan();
    return { text: msg, actions:[
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"},
      {label:"ุชุฑุจุฉ/ุตุฑู", fill:"ุชุฑุจุฉ/ุตุฑู"},
      {label:"ููู ุงุตูุต", fill:"ููู ุงุตูุต"}
    ]};
  }

  // ุญุฑูู/ุจูุน ุจูู
  if(INT.burn.test(t)){
    const msg =
`ูู ูู **ุญุฑูู/ุจูุน ุจูู** ุบุงูุจุงู ูุงุญุฏ ูู ุฏูู:
- ุดูุณ ุถูุฑ ูููุฉ (ุฎุตูุตุงู ูู ุฏุงุฎู ุงูุจูุช ูุงุชุญุท ูุฌุฃุฉ ูู ุดูุณ).
- ุฃููุงุญ/ุชุณููุฏ ุฒูุงุฏุฉ (ุงูุฃุทุฑุงู ุชุชุญุฑู).
- ูุทุฑูุงุช ูู ุงูุจูุน ุจุชูุจุฑ ููุนุงูุง ุณูุงุฏ/ุงุตูุฑุงุฑ.

**ุญู ุณุฑูุน:**
1) ูููู ุดูุณ ูุจุงุดุฑุฉ ูุฎููู ุถูุก ููู.
2) ุงุณูู ุจููุฉ ูููุณุฉ + ุตุฑู ููุชุงุฒ.
3) ูู ุจูุน ุจุชุฒูุฏ: ุดูู ุงููุฑู ุงููุตุงุจ ูุฒููุฏ ุชูููุฉ.`;
    state.lastTopic = "burn";
    state.lastAdviceLong = msg + "\n\n" + KB.fungusPlan();
    return { text: msg, actions:[
      {label:"ูุทุฑูุงุช/ุจูุน", fill:"ุจูุน/ูุทุฑูุงุช"},
      {label:"ููุฑ", fill:"ุงุญุทูุง ูููุ"},
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}
    ]};
  }

  return null;
}

/* =========================================
   12) Main send
========================================= */
function autoGrow(){
  const ta = $("input");
  ta.style.height = "auto";
  ta.style.height = Math.min(140, ta.scrollHeight) + "px";
}
$("input").addEventListener("input", autoGrow);
$("input").addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

function resetChat(){
  $("chat").innerHTML = "";
  state.lastTopic = null;
  state.lastAdviceLong = null;
  state.diag.active = false;
  state.diag.step = 0;
  state.diag.data = {};
  welcome();
}

function welcome(){
  const name = state.plantKey || state.plantRaw || "ูุจุงุช";
  const hello = `ูุง ุฃููุงู ๐\nุฃูุง **${name}** ๐ฟ\nููููู ุฃู ุณุคุงูโฆ ูุฃูุง ูุฑุฏ ุนููู ุจุฑุฏูุฏ ูููุฉ (Offline).\n\nูู ูุชุจุช ุงุณู ุฒุฑุนุฉ ููุญุฏู (ูุซุงู: ุฑูุญุงู) ูุญูููู ุนูููุง ููุฑุงู โ`;
  addMsg("assistant", nl2br(hello), [
    {label:"ุงุฒููุ", fill:"ุงุฒููุ"},
    {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
    {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"},
    {label:"ูุฑููู ุตูุฑู", fill:"ูุฑููู ุตูุฑู"}
  ]);
}

function showHelp(){
  const r = replyHelp();
  addMsg("assistant", nl2br(r.text), r.actions);
}
function showPlantList(){
  const keys = Object.keys(plantDB);
  const msg = `**ุงูุฃููุงุน ุงููุชุงุญุฉ (${keys.length}):**\n` + keys.map(k=>"โข "+k).join("\n") + `\n\nุงูุชุจ ุงุณู ุฃู ุฒุฑุนุฉ ูููู ููุญุฏู ุนุดุงู ุฃุญูููู ุนูููุง.`;
  addMsg("assistant", nl2br(msg), [{label:"ุจุฏูู ุงููุจุงุช", fill:"ุบูุฑ ุงููุจุงุช ู: "}]);
}

function applyPlantChange(newPlant){
  const k = findPlantKeyByName(newPlant) || null;
  const target = k || newPlant;

  const p = new URLSearchParams(location.search);
  p.set("type", target.replace(/\s+/g,"_"));
  history.replaceState(null, "", "?" + p.toString());

  setPlantFromURL();
  resetChat();
}

function send(){
  const ta = $("input");
  const raw = ta.value.trim();
  if(!raw) return;

  addMsg("user", escapeHTML(raw));
  ta.value = "";
  autoGrow();

  const typing = addTyping();

  setTimeout(()=>{
    removeNode(typing);

    const t = normalizeArabic(raw);
    const displayName = state.plantKey || state.plantRaw || "ูุจุงุช";

    // 1) ูู ูู ุชุดุฎูุต ุดุบุงู
    if(state.diag.active){
      continueDiagnosis(raw);
      return;
    }

    // 2) ุชุจุฏูู ูุจุงุช ูู ูุชุจ ุงุณู ุฒุฑุนุฉ ููุท ุฃู ุฐูุฑูุง
    const mentioned = extractPlantMention(raw);
    const changeMatch = t.match(INT.change);
    if(changeMatch && changeMatch[4]){
      applyPlantChange(changeMatch[4]);
      return;
    }
    if(mentioned && mentioned !== state.plantKey){
      applyPlantChange(mentioned);
      return;
    }

    // 3) ุตูุฑ
    if(INT.imageMore.test(t)){
      nextPhoto();
      return;
    }
    if(INT.image.test(t)){
      updatePhoto(false);
      const src = $("plantImg").src;
      addMsg("assistant", `ุงุชูุถู ๐ฟ<br><img class="img-reply" src="${src}" alt="plant">`,
        [{label:"ุตูุฑุฉ ุชุงููุฉ", fill:"ุตูุฑุฉ ุชุงููุฉ"}, {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"}]
      );
      return;
    }

    // 4) ุณุนุฑ
    if(INT.price.test(t)){
      const r = replyPrice();
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }

    // 5) ุชุญูุฉ/ุดูุฑ/ููู ุงูุช
    if(INT.greet.test(t)){
      const r = replyGreeting(displayName);
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(INT.thanks.test(t)){
      addMsg("assistant", nl2br(rand([
        "ุงูุนูู ูุง ุบุงูู ๐ ูู ุงุญุชุฌุช ุฃู ุญุงุฌุฉ ูู ุงูุฑู/ุงูููุฑ/ุงูุฃุนุฑุงุถ ุฃูุง ูุนุงู.",
        "ุญุจูุจู ๐ ุงุณุฃููู ุชุงููโฆ ูุฎููููุง ูุฎูู ุงูุฒุฑุน ูู ุฃุญุณู ุญุงู ๐"
      ])), [{label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"}, {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}]);
      return;
    }
    if(INT.who.test(t)){
      const r = replyWho(displayName);
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }

    // 6) ุฃูุงูุฑ / ุฃููุงุน
    if(INT.help.test(t)){ showHelp(); return; }
    if(INT.list.test(t)){ showPlantList(); return; }

    // 7) ุชุดุฎูุต
    if(INT.diagnose.test(t)){
      startDiagnosis();
      return;
    }

    // 8) ุฎูุงุตุฉ
    if(INT.summary.test(t)){
      const r = replyTopic(displayName, "summary");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }

    // 9) ููุถูุนุงุช
    if(INT.watering.test(t)){
      const r = replyTopic(displayName, "watering");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(INT.light.test(t)){
      const r = replyTopic(displayName, "light");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(INT.fertilize.test(t)){
      const r = replyTopic(displayName, "fertilize");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(t.includes("ุชุฑุจู") || t.includes("ุตุฑู") || INT.soil.test(t)){
      const r = replyTopic(displayName, "soil");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(INT.repot.test(t)){
      const r = replyTopic(displayName, "repot");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(INT.pruning.test(t)){
      const r = replyTopic(displayName, "pruning");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(INT.propagate.test(t) || t.includes("ุงูุซุงุฑ") || t.includes("ุนููู")){
      const r = replyTopic(displayName, "propagate");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(INT.pests.test(t)){
      const r = replyTopic(displayName, "pests");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }
    if(INT.fungus.test(t)){
      const r = replyTopic(displayName, "fungus");
      addMsg("assistant", nl2br(r.text), r.actions);
      return;
    }

    // 10) ุฃุนุฑุงุถ ุฐููุฉ
    const sym = replySymptoms(raw);
    if(sym){
      addMsg("assistant", nl2br(sym.text), sym.actions);
      return;
    }

    // 11) ุงุดุฑุญูู
    if(INT.explain.test(t)){
      if(state.lastAdviceLong){
        addMsg("assistant", nl2br("ุชูุงู โ\n" + state.lastAdviceLong),
          [{label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}, {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"}]
        );
      } else {
        addMsg("assistant", nl2br("ุฃููุฏ โ ููููู ุงููุดููุฉ ุจุงูุชุญุฏูุฏ (ุงุตูุฑุงุฑ/ุฐุจูู/ุจูุน/ุญุดุฑุงุช) ูุงูุง ุฃุดุฑุญูู ุฎุทูุฉ ุจุฎุทูุฉ."),
          [{label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"}]
        );
      }
      return;
    }

    // 12) fallback ููู (ุฃุณุฆูุฉ ุชูุถูุญ + ุจุฏุงุฆู)
    const clar = KB.askClarifiers();
    const fallback =
`ุชูุงูโฆ ุณุคุงูู ูุญุชุงุฌ ุชูุงุตูู ุจุณูุทุฉ ุนุดุงู ุฃุฏูู ุฑุฏ ูุธุจูุท โ
ุงุฎุชุงุฑ/ุฌุงูุจ ุนูู ุฏูู ุจุณุฑุนุฉ:
- ${clar[0]}
- ${clar[1]}
- ${clar[2]}
- ${clar[3]}

ููู ุชุญุจ ููุดููุง ุฃูุชููุงุชูู: ุงูุชุจ **ุชุดุฎูุต**.`;

    addMsg("assistant", nl2br(fallback), [
      {label:"ุชุดุฎูุต", fill:"ุชุดุฎูุต"},
      {label:"ุฎูุงุตุฉ ุงูุนูุงูู", fill:"ุฎูุงุตุฉ ุงูุนูุงูู"},
      {label:"ุฑู", fill:"ุงูุชู ุงุณููุ"},
      {label:"ุญุดุฑุงุช", fill:"ูู ุญุดุฑุงุช"}
    ]);
  }, 450);
}

/* =========================================
   13) Init
========================================= */
function init(){
  setPlantFromURL();
  renderQuick();
  resetChat();
}
init();
</script>
</body>
</html>
