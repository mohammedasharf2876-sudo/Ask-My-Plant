<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ูุดุชู ูุญูุฏ ุงูุฐูู</title>

  <style>
    :root{
      --g1:#1b5e20;
      --g2:#2e7d32;
      --bg:#fdfbf7;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 8px 22px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: var(--bg);
      margin:0;
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* TOP */
    .top{
      background: linear-gradient(90deg, var(--g1), var(--g2));
      color:#fff;
      padding:14px 14px 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,.12);
    }
    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .brand .title{
      font-weight:900;
      font-size:1.1rem;
      display:flex;
      gap:8px;
      align-items:center;
      max-width:70vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .tools{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn-mini{
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.14);
      color:#fff;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:.85rem;
      backdrop-filter: blur(6px);
    }
    .btn-mini:active{transform:scale(.98)}

    .plant-card{
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.25);
      border-radius: var(--radius);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .plant-img{
      width:72px;
      height:72px;
      border-radius:16px;
      overflow:hidden;
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.08);
      position:relative;
    }
    .plant-img img{width:100%;height:100%;object-fit:cover;display:block}
    .plant-img .badge{
      position:absolute;
      bottom:6px;
      left:6px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      font-size:.75rem;
      padding:3px 8px;
      border-radius:999px;
      backdrop-filter: blur(6px);
    }

    .plant-meta{flex:1; min-width:0;}
    .plant-meta .name{
      font-weight:900;
      font-size:1rem;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .plant-meta .sub{
      font-size:.86rem;
      opacity:.95;
      color:#f1f5f9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chips{
      margin-top:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.14);
      color:#fff;
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:.82rem;
      user-select:none;
    }
    .chip:active{transform:scale(.98)}

    /* CHAT */
    #chatBox{
      flex:1;
      padding:14px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      background-image: radial-gradient(#dcedc8 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .msg{
      padding:12px 16px;
      border-radius:20px;
      max-width: 92%;
      font-size:15px;
      line-height:1.75;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
      word-break:break-word;
    }
    .bot{
      background: var(--card);
      align-self:flex-start;
      color:#111827;
      border-bottom-right-radius: 6px;
      border:1px solid var(--line);
    }
    .user{
      background: var(--g2);
      align-self:flex-end;
      color:#fff;
      border-bottom-left-radius: 6px;
    }
    .meta-line{
      margin-top:8px;
      font-size:.85rem;
      color: var(--muted);
    }
    .mini-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .mini-actions button{
      border:1px solid var(--line);
      background:#fff;
      padding:7px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:.85rem;
    }
    .mini-actions button:hover{background:#f9fafb}

    .img-reply{
      width:100%;
      max-width:360px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      margin-top:10px;
      display:block;
    }

    .typing{
      opacity:.9;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:#111827;
    }
    .dots{display:inline-flex; gap:4px;}
    .dot{
      width:6px;height:6px;border-radius:50%;
      background:#9ca3af;
      animation: bounce 1s infinite ease-in-out;
    }
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}

    /* INPUT */
    .input-area{
      background:#fff;
      padding:12px;
      display:flex;
      gap:10px;
      border-top:1px solid var(--line);
      align-items:center;
    }
    input{
      flex:1;
      padding:12px 16px;
      border:2px solid #e5e7eb;
      border-radius:999px;
      outline:none;
      font-size:16px;
      transition:.25s;
    }
    input:focus{border-color: var(--g2)}
    .btn-send{
      background: var(--g1);
      color:#fff;
      border:none;
      padding:12px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .btn-voice{
      background:#fff;
      color: var(--g1);
      border:2px solid #e5e7eb;
      padding:12px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
    }
    .btn-voice.active{
      border-color: var(--g2);
      box-shadow: 0 0 0 4px rgba(46,125,50,.15);
    }

    @media (max-width:420px){
      .plant-img{width:62px;height:62px}
      .btn-mini{padding:7px 9px}
      .chip{padding:6px 9px}
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="brand">
      <div class="title" id="plantTitle">ูุจุชุชู ุงูุฐููุฉ ๐ฑ</div>
      <div class="tools">
        <button class="btn-mini" onclick="showHelp()">ุงูุฃูุงูุฑ</button>
        <button class="btn-mini" onclick="showPlantList()">ุงูุฃููุงุน</button>
        <button class="btn-mini" onclick="resetChat()">ุจุฏุงูุฉ ุฌุฏูุฏุฉ</button>
      </div>
    </div>

    <div class="plant-card">
      <div class="plant-img">
        <img id="plantImg" alt="ุตูุฑุฉ ุงููุจุงุช" />
        <div class="badge" id="imgBadge">ุตูุฑุฉ</div>
      </div>
      <div class="plant-meta">
        <div class="name" id="plantName">โ</div>
        <div class="sub" id="plantSub">โ</div>
        <div class="chips" id="quickChips"></div>
      </div>
    </div>
  </div>

  <div id="chatBox"></div>

  <div class="input-area">
    <button class="btn-voice" id="voiceBtn" onclick="toggleVoice()">๐ค</button>
    <input id="userInput" type="text" placeholder="ููู ุฃู ุญุงุฌุฉโฆ (ุงุฒููุ ุฑูุ ุงุตูุฑุงุฑุ ุญุดุฑุงุชุ ูุฑููู ุตูุฑุฉุ)" onkeypress="handleEnter(event)" />
    <button class="btn-send" onclick="replyLogic()">ุฅุฑุณุงู</button>
  </div>

<script>
/* =========================================================
  โ ุงููุฏู:
  - ูู QR ููุชุญ ุดุงุช ูุฒุฑุนุฉ ูุงุญุฏุฉ (type=ุงุณู ุงูุฒุฑุนุฉ)
  - ุงููุณุชุฎุฏู ููุฏุฑ ูููู ุฃู ููุงู (ุณูุงู/ุงุฒูู/ุงุดุฑุญูู/ูุดุงูู/ุญุดุฑุงุช...)
  - ูู ูุชุจ ุงุณู ุฒุฑุนุฉ (ูุซูุงู "ุฑูุญุงู") ูุชุญูู ุชููุงุฆูุงู ููุง ุจุณูููุฉ
  - ููู ุฌุฏุงู: ูุด ููุญูุธ ูุญุงุฏุซุฉ ุนูู ุงูุฌูุงุฒ (ุฎุตูุตูุฉ + ูุงูุจูุงุด "ุญุงูุธ ูููุชูู")
     โ ุงุณุชุฎุฏุงู sessionStorage ูุน ูุณุญ ุชููุงุฆู ุนูุฏ ูุชุญ ุงูุตูุญุฉ (ุงูุชุฑุงุถู)
     โ ุชูุฏุฑ ุชุฎูููุง ุชุญูุธ ูุคูุชุงู ุจูุถุน keep=1 ูู ุงูุฑุงุจุท
        ูุซุงู: ?type=ูุงุณููู&keep=1
========================================================= */

/* =========================
   1) ุฅุนุฏุงุฏุงุช
========================= */
const SETTINGS = {
  // ุงูุชุฑุงุถู: ูู ูุชุญู ุฌุฏูุฏุฉ ุชุจุฏุฃ ูู ุงูุตูุฑ (ุญู ูุดููุฉ "ุญุงูุธ ูููุชูู")
  RESET_ON_LOAD: true,

  // ุนุฏุฏ ุงูุชุฑุงุญุงุช ุงูุฃุฒุฑุงุฑ ูู ูู ุฑุฏ
  MAX_ACTIONS: 4
};

/* =========================
   2) ูุงุนุฏุฉ ุจูุงูุงุช ุงููุจุงุชุงุช
   - img: ูู ุนูุฏู ุตูุฑ ุซุงุจุชุฉุ ุถูู array ุฑูุงุจุท ููุง
   - q: ูููุฉ ุจุญุซ ููุตูุฑ (ูู img ูุด ููุฌูุฏุฉ ููุฌูุจ ูู Unsplash ุชููุงุฆู)
========================= */
const plantDB = {
  // ุนุทุฑูุงุช ูุฃุนุดุงุจ
  "ุฑูุญุงู": { cat:"ุนุทุฑู/ุนุดุจ", q:"basil herb plant", aliases:["ุญุจู"], w:"ููู ูููู (ุงูุชุฑุจุฉ ุฑุทุจุฉ ุฏุงุฆูุงู ุจุฏูู ุฅุบุฑุงู)", s:"ุดูุณ ูุจุงุดุฑุฉ ุตุจุงุญุงู + ุชูููุฉ", f:"ุณูุงุฏ ุนุถูู ุฎููู ูู ุดูุฑ", n:"ุงูุทู ุงูููู ุงููุงููุฉ ุนุดุงู ููุฑูุน." },
  "ูุนูุงุน": { cat:"ุนุทุฑู/ุนุดุจ", q:"mint plant", aliases:["ูุนูุงุน ุจูุฏู"], w:"ูู ููู ูู ุงูุตูู (ุจูุญุจ ุงูููุฉ) + ูุงุฒู ุตุฑู ูููุณ", s:"ุดูุณ ุฎูููุฉ ุฃู ูุตู ุธู", f:"ุณูุงุฏ ูุชูุงุฒู NPK ุฎููู ูู 3-4 ุฃุณุงุจูุน", n:"ุงูุฌุฐูุฑ ุจุชุฌุฑูโฆ ุงูุฃูุถู ูู ุฃุตูุต ููุญุฏู." },
  "ุฑูุฒูุงุฑู": { cat:"ุนุทุฑู/ุนุดุจ", q:"rosemary plant", aliases:["ุฅูููู ุงูุฌุจู"], w:"ููุง ุงูุชุฑุจุฉ ุชูุดู ุชูุงูุงู", s:"ุดูุณ ูููุฉ (ุจูุชุญูู)", f:"ูุด ูุญุชุงุฌ ุชุณููุฏ ูุชูุฑ", n:"ุฑูุญุชู ุจุชุทุฑุฏ ุจุนุถ ุงูุญุดุฑุงุช." },
  "ุฒุนุชุฑ": { cat:"ุนุทุฑู/ุนุดุจ", q:"thyme herb plant", aliases:["ุฒุนุชุฑ ุจูุฏู"], w:"ูููู ุฌุฏุงู (ุจููุฑู ุงูููุฉ ุงููุชูุฑ)", s:"ุดูุณ ูุงููุฉ", f:"ูุฑุฉ ูู ููุณู", n:"ููู ูุจูุชูุจู ุงูุฌูุงู." },
  "ูุงููุฏุฑ": { cat:"ุนุทุฑู/ุนุดุจ", q:"lavender plant", aliases:["ุฎูุฒุงูู"], w:"ููุง ุงูุชุฑุจุฉ ุชุฌู (ุจููุฑู ุงูุฑุทูุจุฉ)", s:"ุดูุณ ูููุฉ ุฌุฏุงู", f:"ูููู ุฌุฏุงู", n:"ุจูุญุจ ุงูุฌู ุงูุฌุงู ูุงูุชูููุฉ." },

  // ุฒููุฑ ููุฒูุฑุงุช
  "ูุฑุฏ ุจูุฏู": { cat:"ุฒููุฑ", q:"rose plant", aliases:["ูุฑุฏ"], w:"ููู ูููู ุจุงูุชุธุงู ุญุณุจ ุงูุฌู", s:"ุดูุณ ูุจุงุดุฑุฉ 6 ุณุงุนุงุช ุนูู ุงูุฃูู", f:"NPK ุนุงูู ุงูุจูุชุงุณููู ููุช ุงูุชุฒููุฑ", n:"ูุต ุงููุฑุฏ ุงูุฏุจูุงู ุฃูู ุจุฃูู." },
  "ูู": { cat:"ุฒููุฑ", q:"jasmine sambac plant", aliases:["ูู ุจูุฏู"], w:"ูู ููููู (ุชุฑุจุฉ ุฑุทุจุฉ ุจุฏูู ุบุฑู)", s:"ุดูุณ ูุบุฑุจูุฉ (ูุด ุญุงุฑูุฉ)", f:"ุญุฏูุฏ ูู ุดูุฑ ูู ุงููุฑู ุจูุตูุฑ", n:"ุฑูุญุชูุง ุจุชููู ููุช ุงูุบุฑูุจ." },
  "ูุงุณููู": { cat:"ุฒููุฑ/ูุชุณูู", q:"jasmine vine plant", aliases:["ูุงุณููู ูุชุณูู"], w:"ูุนุชุฏู (ููุง ุงููุด ููุดู)", s:"ุดูุณ ูุงููุฉ ุฃู ุดูุณ ุตุจุงุญ", f:"ุณูุงุฏ ูุชูุงุฒู", n:"ูุญุชุงุฌ ุฏุนุงูุฉ/ุดุจู ููุชุณูู." },
  "ุฌุงุฑุฏูููุง": { cat:"ุฒููุฑ", q:"gardenia plant", aliases:["Gardenia"], w:"ููุงู ููููุฉ ุงููููุฑ + ุซุจุงุช ูู ุงูุฑู", s:"ุถูุก ููู ุฌุฏุงู ุบูุฑ ูุจุงุดุฑ", f:"ุญุฏูุฏ + ุณูุงุฏ ุญุงูุถู", n:"ุจุชูุฑู ุชุบููุฑ ุงูููุงู ูุฌุฃุฉ." },
  "ูุณู ุงูููู": { cat:"ุฒููุฑ", q:"night blooming jasmine plant", aliases:["ูุณู"], w:"ููู ูููู", s:"ุดูุณ ูุจุงุดุฑุฉ", f:"ุณูุงุฏ ุจูุฏู/ุนุถูู", n:"ุฑูุญุชูุง ุจุชุฒูุฏ ุจุงูููู." },
  "ุฌููููุฉ": { cat:"ุฒููุฑ ุฎุงุฑุฌูุฉ", q:"bougainvillea plant", aliases:["ุจูฺููููุง"], w:"ุชุนุทูุด ุฎููู ุนุดุงู ุชุฒูุฑ (ูููู)", s:"ุดูุณ ุญุงุฑูุฉ ุทูู ุงูููู", f:"ูุด ูุญุชุงุฌุฉ ุฏูุน", n:"ูู ูุง ุชูู ุงูููุฉ ุชุทูุน ูุฑุฏ ุฃูุชุฑ (ูู ุบูุฑ ูุง ุชุฐุจู)." },
  "ูุงูุจุณูุณ": { cat:"ุฒููุฑ", q:"hibiscus plant", aliases:["ูุฑูุฏูู ุฒููุฉ","ููุจุณูุณ"], w:"ููู ูููู ูู ุงูุตูู", s:"ุดูุณ ูุจุงุดุฑุฉ", f:"NPK ูู ุฃุณุจูุนูู", n:"ุฒูุฑุชูุง ููู ูุงุญุฏ ุจุณโฆ ุจุณ ุดูููุง ุฑููุจ." },
  "ูููุง": { cat:"ุฒููุฑ", q:"vinca plant", aliases:["ูููุง ุฑูุฒ"], w:"ูู ููู ูู ุงูุญุฑ ูู ุฃุตูุต ุตุบูุฑ", s:"ุดูุณ ุฃู ูุตู ุธู", f:"NPK ูุชุนุงุฏู", n:"ูู ุฃููู ุงููุฒูุฑุงุช ูู ุญุฑ ูุตุฑ." },
  "ุฌุงุฑูููุง": { cat:"ุฒููุฑ", q:"geranium plant", aliases:["ุฌุฑุงูููู","ุฅุจุฑุฉ ุงูุฑุงุนู"], w:"ูุนุชุฏู", s:"ุดูุณ ุงูุตุจุญ ุจุณ", f:"ุจูุชุงุณููู ููุชุฒููุฑ", n:"ุจุชุญุจ ููุงุก ูููุงู ูููุฑ." },

  // ูุจุงุชุงุช ุฒููุฉ ุฏุงุฎููุฉ
  "ุจูุชุณ": { cat:"ุฏุงุฎูู", q:"pothos plant", aliases:["ุจูุชุณ ุฐูุจู","Pothos"], w:"ูู 4-5 ุฃูุงู (ููุง ุงูุชุฑุจุฉ ุชูุดู)", s:"ุถูุก ุดุจุงู/ููุจุฉ (ุถู)", f:"ุณูุงุฏ ูุฑูู ุฎููู", n:"ุฃุณูู ุฒุฑุนุฉ ูููุจุชุฏุฆูู." },
  "ุฌูุฏ ุงูููุฑ": { cat:"ุฏุงุฎูู", q:"snake plant sansevieria", aliases:["ุณุงูุณูููุฑูุง","ุณูุณููุฑูุง"], w:"ูู ุฃุณุจูุนูู ูุฑุฉ (ุงูุณุงู)", s:"ุฃู ุฅุถุงุกุฉ (ูููุฉ ุฃู ุถุนููุฉ)", f:"ูุด ูุญุชุงุฌ", n:"ุงูุฒูุงุฏุฉ ูู ุงูุฑู ุจุชุนูููู." },
  "ุฒุงููุง": { cat:"ุฏุงุฎูู", q:"zz plant zamioculcas", aliases:["ZZ"], w:"ูุฑุฉ ูู 20 ููู", s:"ุถู ูุงูู ุฃู ุถูุก ุฎููู", f:"NPK ูู ุดูุฑูู", n:"ุดูููุง ุดูู ูุจุชููุน." },
  "ูููุณุชููุฑุง": { cat:"ุฏุงุฎูู", q:"monstera deliciosa plant", aliases:["ูููุณุชูุฑุง"], w:"ููุง ูุต ุงูุชุฑุจุฉ ููุดู", s:"ุถูุก ุณุงุทุน ุบูุฑ ูุจุงุดุฑ", f:"NPK ุดูุฑูุงู (ุฑุจูุน/ุตูู)", n:"ุจุชุญุจ ุฑุทูุจุฉ ุงูุฌูโฆ ุฑุด ุฎููู." },
  "ุฏุฑุงุณูุจูุง": { cat:"ุฏุงุฎูู", q:"dracaena plant", aliases:["ุฏุฑุงุณููุง"], w:"ูุนุชุฏู", s:"ุถูุก ูุชูุณุท", f:"ุณูุงุฏ ุฃุฎุถุฑ", n:"ุงูุณุญ ุงููุฑู ุนุดุงู ูููุน." },
  "ุณูุฌููููู": { cat:"ุฏุงุฎูู", q:"syngonium plant", aliases:["ุณูุบููููู"], w:"ุฑุทูุจุฉ ูุณุชูุฑุฉ ุจุฏูู ุบุฑู", s:"ุถู", f:"NPK ุฎููู", n:"ุจุชูุจุฑ ุจุณุฑุนุฉ ููุฑููุง ุดุจู ุงูุณูู." },
  "ุงูุชูุฑููู": { cat:"ุฏุงุฎูู", q:"anthurium plant", aliases:["ุฃูุซูุฑููู"], w:"ููุงู ููููุฉ ุงููููุฑ", s:"ุถูุก ููู ุฌุฏุงู ุฏุงุฎู ุงูุจูุช", f:"ุณูุงุฏ ุฒููุฑ", n:"ุฒูุฑุชูุง ุจุชูุถู ูุฏุฉ ุทูููุฉ." },
  "ูููุณ ุฏูููุฑุง": { cat:"ุฏุงุฎูู/ูุตู ุฎุงุฑุฌู", q:"ficus elastica rubber plant", aliases:["ูููุณ ูุทุงุท","ุฑูุจุฑ"], w:"ููุง ุงูุชุฑุจุฉ ุชูุดู ุชูุงูุงู", s:"ุถูุก ุดุจุงู ููู", f:"NPK", n:"ูุถูู ุงููุฑู ุจููุงุดุฉ ูุจูููุฉ." },
  "ุจุงูุจู": { cat:"ุฏุงุฎูู", q:"lucky bamboo plant", aliases:["ูุงูู ุจุงูุจู"], w:"ุบูุฑ ุงูููุฉ ูู ุฃุณุจูุน (ูู ูู ูุงุฒุฉ)", s:"ุถูุก ุบุฑูุฉ", f:"ููุทุชูู ูุบุฐู ูู ุงูููุฉ", n:"ุฎููู ุนูู ููุฉ ูุธููุฉ ุนุดุงู ููุนููุด." },
  "ูุฑูุชูู": { cat:"ุฏุงุฎูู", q:"croton plant", aliases:["ูุฑูุชู"], w:"ุจูุญุจ ุงูุนุทุด ุดููุฉ ุจูู ุงูุฑูุงุช", s:"ุถูุก ููู ุนุดุงู ููููู", f:"NPK", n:"ูู ุงูุถูุก ููโฆ ุงููุฑู ูุฎุถุฑ." },
  "ุฃุฌูููููุง": { cat:"ุฏุงุฎูู", q:"aglaonema plant", aliases:["ุฃุฌูููููุฉ"], w:"ูุนุชุฏู", s:"ุถู ุฃู ุถูุก ุฎููู", f:"NPK ุฎููู", n:"ุจุชุณุชุญูู ููุฉ ุงูุถูุก." },
  "ููุฌูุฑ": { cat:"ุฏุงุฎูู", q:"fern plant", aliases:["ุณุฑุฎุณ"], w:"ุจูุญุจ ุงูููุฉ ูุงูุฑุด", s:"ุถู ูุฑุทูุจุฉ", f:"ุณูุงุฏ ูุฑูู", n:"ุนุงูุฒ ุฑุทูุจุฉ ุซุงุจุชุฉ." },
  "ูููุง": { cat:"ุฏุงุฎูู/ุฎุงุฑุฌู", q:"yucca plant", aliases:["ูููุง ููู"], w:"ูููู ุฌุฏุงู", s:"ุดูุณ ุฃู ุถู", f:"ูุชูุงุฒู ูู ุดูุฑูู", n:"ููู ุฌุฏุงู ููุด ุฏููุน." },
  "ุดูููุฑุง": { cat:"ุฏุงุฎูู", q:"schefflera plant", aliases:["ุดููููุฑุง"], w:"ูุนุชุฏู", s:"ุถูุก ููู", f:"NPK", n:"ูู ุงุชุทููุชโฆ ูุต ุงูููู ูุชูุฑูุน." },

  // ุตุจุงุฑุงุช ูุนุตุงุฑูุงุช
  "ุตุจุงุฑ": { cat:"ุนุตุงุฑูุงุช", q:"cactus plant", aliases:["ูุงูุชูุณ"], w:"ููุทุฉ ููุฉ ูู ุดูุฑ (ุญุณุจ ุงูุฌู)", s:"ุดูุณ ุฃู ุถูุก ููู", f:"ูุด ูุญุชุงุฌ", n:"ุงูุฒูุงุฏุฉ ูู ุงูุฑู = ุนูู." },
  "ุงููููุฑุง": { cat:"ุนุตุงุฑูุงุช", q:"aloe vera plant", aliases:["ุฃููููุฑุง","ุฃููุฉ"], w:"ูู 3 ุฃุณุงุจูุน", s:"ุดูุณ ุฎูููุฉ", f:"ูุฑุฉ ูู ุงูุณูุฉ", n:"ุงูุฌู ูููุฏโฆ ุจุณ ุจูุงุด ุบุฑู." },
  "ุฅูุดููุฑูุง": { cat:"ุนุตุงุฑูุงุช", q:"echeveria succulent", aliases:["Echeveria"], w:"ูููู ุฌุฏุงู", s:"ุดูุณ", f:"ุณูุงุฏ ูุงูุชูุณ ุฎููู", n:"ูุชูููุณุด ููุจูุง ููุฉ ูุชูุฑ." },
  "ูุงูุงูุดู": { cat:"ุนุตุงุฑูุงุช ูุฒูุฑุฉ", q:"kalanchoe plant", aliases:["ูุงูุงูููุง"], w:"ููุง ุงูุชุฑุจุฉ ุชุญุฌุฑ", s:"ุถูุก ุดุจุงู", f:"NPK ุฎููู", n:"ุฒููุฑ ุฃููุงู ูุชูุฑ." },

  // ุฃุดุฌุงุฑ ูุดุฌูุฑุงุช ุฎุงุฑุฌูุฉ
  "ูููุณ ูุชุฏุง": { cat:"ุฎุงุฑุฌู", q:"ficus nitida tree", aliases:["ูููุณ ููุชูุฏุง","ูููุณ ุณูุฑ"], w:"ููู ูููู", s:"ุดูุณ", f:"NPK ุนุงูู ุงูููุชุฑูุฌูู", n:"ููุชุงุฒ ูุณูุฑ ุดุฌุฑู." },
  "ุชููููุง": { cat:"ุฎุงุฑุฌู", q:"tecoma stans plant", aliases:["ุชููููุง ุตูุฑุงุก"], w:"ูุนุชุฏู", s:"ุดูุณ", f:"ูุชูุงุฒู", n:"ูุฑุฏูุง ุฃุตูุฑ ูุจูุฌ." },
  "ูุงูุชุงูุง": { cat:"ุฎุงุฑุฌู", q:"lantana plant", aliases:["ูุงูุชุงูุง ููููุฉ"], w:"ูููู", s:"ุดูุณ ุญุงุฑูุฉ", f:"ูุด ุถุฑูุฑู", n:"ุจุชูู ูุฑุงุดุงุช ูุฃููุงููุง ุจุชุชุบูุฑ." },
  "ููุฑููุฌุง": { cat:"ุฎุงุฑุฌู", q:"moringa tree", aliases:["ููุฑููุบุง"], w:"ูุนุชุฏู", s:"ุดูุณ", f:"ุนุถูู", n:"ูุฑููุง ูููุฏโฆ ุจุณ ูุญุชุงุฌุฉ ุดูุณ." },
  "ููููู": { cat:"ูุซูุฑ", q:"lemon tree", aliases:["ููููู ุจูุฏู"], w:"ููุชุธู (ุจููุฑู ุงูุนุทุด)", s:"ุดูุณ ูุงููุฉ", f:"ุญุฏูุฏ + ุนูุงุตุฑ ุตุบุฑู", n:"ุนุดุงู ูุทุฑุญ: ุดูุณ + ุชุณููุฏ + ุฑู ููุชุธู." },
  "ุฒูุชูู": { cat:"ูุซูุฑ", q:"olive tree", aliases:["ุดุฌุฑุฉ ุฒูุชูู"], w:"ูููู", s:"ุดูุณ", f:"ุนุถูู", n:"ุดุฌุฑุฉ ูุนููุฑุฉ ูุชุณุชุญูู." },

  // ุฅุถุงูุงุช
  "ุณุฌุงุฏ": { cat:"ุฏุงุฎูู", q:"spider plant chlorophytum", aliases:["ุณุจุงูุฏุฑ","ูููุฑูููุชูู"], w:"ูู ููููู/3 ุญุณุจ ุงูุฌู", s:"ุดูุณ ุฎูููุฉ ุฃู ุถู ูููุฑ", f:"NPK", n:"ูุต ุงูุดูุฑูุฎ ุงูุฒูุฑู ูู ุนุงูุฒ ุงููุฑู ูููู." },
  "ูุทููุฉ": { cat:"ุฒููุฑ", q:"marigold plant", aliases:["ูุทููุฉ ุจูุฏู","ูุงุฑูุฌููุฏ"], w:"ููู ูููู", s:"ุดูุณ", f:"NPK", n:"ุจุชุฒูุฑ ูููุณ ูู ุงูุฌู ุงููุนุชุฏู." },
  "ูุฑููู": { cat:"ุฒููุฑ", q:"carnation plant", aliases:["ูุฑููู ุจูุฏู"], w:"ูุนุชุฏู", s:"ุดูุณ", f:"ูุชูุงุฒู", n:"ููุงุก ูููุณ ูููู ุงููุทุฑูุงุช." },
  "ูุนูุงุน ุณุนูุฏู": { cat:"ุนุทุฑู/ุนุดุจ", q:"mint plant", aliases:["ูุนูุงุน ุตุบูุฑ"], w:"ูุชูุฑ", s:"ูุตู ุธู", f:"ุนุถูู", n:"ุฑูุญุชู ูููุฉโฆ ุจุณ ุนุงูุฒ ุฑู ุฃูุชุฑ." },
  "ุฒุนุชุฑ ุจุฑู": { cat:"ุนุทุฑู/ุนุดุจ", q:"wild thyme plant", aliases:["ุฒุนุชุฑ ุฌุจูู"], w:"ูููู", s:"ุดูุณ", f:"ูุง ููุฌุฏ", n:"ูุชุญูู ุญุฑุงุฑุฉ ูุฌูุงู." },
  "ุฃูุงุณูุง": { cat:"ุฎุงุฑุฌู", q:"acacia tree", aliases:["ุงูุงุณูุง"], w:"ูููู", s:"ุดูุณ", f:"ูุง ููุฌุฏ", n:"ุดุฌุฑุฉ ุธู ููุชุงุฒุฉ." },
  "ุจููุณูุงุชุง": { cat:"ุฏุงุฎูู/ูุตู ุฎุงุฑุฌู", q:"poinsettia plant", aliases:["ุจูุช ุงูููุตู","ุจูููุณูุงุชูุง"], w:"ูุนุชุฏู", s:"ุถูุก ุณุงุทุน", f:"NPK", n:"ุจุชูููู ูู ุงูุดุชุงุก ูู ุฅุถุงุกุฉ ูููุณุฉ." },
  "ุฏุฑุงุณููุง ููููู": { cat:"ุฏุงุฎูู", q:"dracaena lemon lime plant", aliases:["ุฏุฑุงุณููุง ููููู ูุงูู"], w:"ููุง ุชุฌู", s:"ุถูุก ูุชูุณุท", f:"ูุฑูู", n:"ููููุง ูุจูุฌโฆ ุจูุงุด ุดูุณ ุญุงุฑูุฉ." },
};

/* =========================
   3) ุงูุญุงูุฉ (Context)
========================= */
const state = {
  plantKey: null,
  plantNameFromURL: null,
  plantObj: null,
  lastTopic: null,        // ุงุฎุฑ ููุถูุน ุงุชููููุง ููู
  lastAdvice: null,       // ูุต ุขุฎุฑ ูุตูุญุฉ/ุฎูุงุตุฉ (ุนุดุงู "ุงุดุฑุญูู")
  imgIndex: 0,
  voiceOn: false,
  recognition: null
};

/* =========================
   4) Quick Chips (ุฃุณุฆูุฉ ูุชููุนุฉ)
========================= */
const QUICK_CHIPS = [
  "ุงุฒููุ",
  "ุฎูุงุตุฉ ุงูุนูุงูุฉ",
  "ุงูุชู ุฃุณููุ",
  "ุฃุญุทู ูููุ",
  "ุณูุงุฏ ุงููุ",
  "ูุฑูู ุจูุตูุฑโฆ ูููุ",
  "ูู ุญุดุฑุงุชโฆ ุฃุนูู ุงููุ",
  "ุงููู ุงูุฃุตูุต ุงูุชูุ",
  "ุฅูุซุงุฑ ุงุฒุงูุ",
  "ุชููููุ",
  "ูุฑููู ุตูุฑุฉ"
];

/* =========================
   5) ุฃุฏูุงุช
========================= */
function escapeHTML(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normalizeArabic(str){
  if(!str) return "";
  return str.toString().trim().toLowerCase()
    .replace(/[ุฅุฃุขุง]/g,"ุง")
    .replace(/ู/g,"ู")
    .replace(/ุฉ/g,"ู")
    .replace(/ุค/g,"ู")
    .replace(/ุฆ/g,"ู")
    .replace(/ู/g,"")
    .replace(/[ูููููููู]/g,"")
    .replace(/\s+/g," ");
}
function similarity(a,b){
  a = normalizeArabic(a); b = normalizeArabic(b);
  if(!a || !b) return 0;
  if(a === b) return 1;
  const A = new Set(a.split(" "));
  const B = new Set(b.split(" "));
  let inter=0;
  for(const x of A) if(B.has(x)) inter++;
  const union = A.size + B.size - inter;
  let score = union ? inter/union : 0;
  if(b.startsWith(a) || a.startsWith(b)) score += 0.2;
  return Math.min(1, score);
}
function findPlantKeyByName(name){
  const n = normalizeArabic(name);
  if(!n) return null;

  // direct match
  for(const key of Object.keys(plantDB)){
    if(normalizeArabic(key) === n) return key;
  }
  // alias match
  for(const [key,obj] of Object.entries(plantDB)){
    for(const al of (obj.aliases || [])){
      if(normalizeArabic(al) === n) return key;
    }
  }
  // fuzzy
  let bestKey=null, bestScore=0;
  for(const [key,obj] of Object.entries(plantDB)){
    let sc = similarity(n, key);
    if(sc > bestScore){ bestScore=sc; bestKey=key; }
    for(const al of (obj.aliases || [])){
      let sc2 = similarity(n, al);
      if(sc2 > bestScore){ bestScore=sc2; bestKey=key; }
    }
  }
  return bestScore >= 0.55 ? bestKey : null;
}
function getUnsplash(query){
  const q = encodeURIComponent((query || "plant").toString());
  return `https://source.unsplash.com/640x480/?${q}`;
}

/* =========================
   6) ูุงุฌูุฉ ุงูุฑุณุงุฆู
========================= */
function addMsg(html, side, actions=null){
  const box = document.getElementById("chatBox");
  const div = document.createElement("div");
  div.className = `msg ${side}`;
  div.innerHTML = html;

  if(actions && side==="bot" && actions.length){
    const wrap = document.createElement("div");
    wrap.className = "mini-actions";
    actions.slice(0, SETTINGS.MAX_ACTIONS).forEach(a=>{
      const b = document.createElement("button");
      b.type="button";
      b.textContent = a.label;
      b.onclick = ()=> {
        document.getElementById("userInput").value = a.fill;
        document.getElementById("userInput").focus();
      };
      wrap.appendChild(b);
    });
    div.appendChild(wrap);
  }

  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
function addTyping(){
  const html = `<span class="typing">ุจููุฑโฆ <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>`;
  addMsg(html, "bot");
  return document.querySelector("#chatBox .msg.bot:last-child");
}
function removeTyping(node){
  if(node && node.parentNode) node.parentNode.removeChild(node);
}
function handleEnter(e){
  if(e.key === "Enter") replyLogic();
}

/* =========================
   7) ุถุจุท ุงููุจุงุช ูู QR
========================= */
function setPlant(typeFromURL){
  state.plantNameFromURL = typeFromURL || "ุนุงูุฉ";
  const maybeKey = findPlantKeyByName(state.plantNameFromURL);
  state.plantKey = maybeKey;
  state.plantObj = maybeKey ? plantDB[maybeKey] : null;
  state.imgIndex = 0;

  const displayName = maybeKey || state.plantNameFromURL || "ุนุงูุฉ";
  document.getElementById("plantTitle").innerText = "ุฏุฑุฏุดุฉ ูุน: " + displayName + " ๐ฑ";
  document.getElementById("plantName").innerText = displayName;

  const sub = state.plantObj
    ? `ููุน: ${state.plantObj.cat} โข ุงุณุฃููู ุจุฃู ุตูุบุฉโฆ ุฃูุง ูุงูููู`
    : `ูุด ูุงูู ุงูููุน ุฏูโฆ ุจุณ ูุณุงุนุฏู ุจุฑุถู (ุฑู/ููุฑ/ุฃุนุฑุงุถ/ุญุดุฑุงุช)`;

  document.getElementById("plantSub").innerText = sub;

  // Image
  updatePlantImage(true);

  renderChips();
}
function updatePlantImage(initial=false){
  const imgEl = document.getElementById("plantImg");
  const badge = document.getElementById("imgBadge");

  const displayName = state.plantKey || state.plantNameFromURL || "plant";
  const p = state.plantObj;

  let src = "";
  if(p?.img && Array.isArray(p.img) && p.img.length){
    src = p.img[state.imgIndex % p.img.length];
    badge.textContent = `ุตูุฑุฉ ${ (state.imgIndex % p.img.length) + 1 }/${p.img.length}`;
  }else{
    // ุตูุฑ ุนุดูุงุฆูุฉ ุญุณุจ ุงูุจุญุซ
    const q = p?.q || displayName;
    src = getUnsplash(q + (initial ? "" : `&sig=${Date.now()}`));
    badge.textContent = "ุตูุฑุฉ";
  }

  imgEl.src = src;
  imgEl.onerror = () => { imgEl.src = getUnsplash("plant"); };
}
function renderChips(){
  const box = document.getElementById("quickChips");
  box.innerHTML = "";
  QUICK_CHIPS.forEach(t=>{
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = t;
    c.onclick = ()=>{ document.getElementById("userInput").value = t; document.getElementById("userInput").focus(); };
    box.appendChild(c);
  });
}

/* =========================
   8) โุจุฏุงูุฉ ุฌุฏูุฏุฉโ (ุญู ูุดููุฉ ุญูุธ ุงูููุงู)
========================= */
function resetChat(){
  document.getElementById("chatBox").innerHTML = "";
  state.lastTopic = null;
  state.lastAdvice = null;
  welcome();
}

/* =========================
   9) ุฃูุงูุฑ ููุณุงุนุฏุฉ
========================= */
function showHelp(){
  const html = `
    <b>ุฃูุง ุจููู ุฃุบูุจ ููุงู ุงููุงุณ โค๏ธ</b><br>
    ุฌุฑุจ ุชููู ุฃู ุญุงุฌุฉ ุฒู:<br>
    โข <b>ุงุฒููุ</b> / <b>ููู ุงูุชูุ</b><br>
    โข <b>ุงูุชู ุฃุณููุ</b> / <b>ุฃุญุทู ูููุ</b> / <b>ุณูุงุฏ ุงููุ</b><br>
    โข <b>ูุฑูู ุจูุตูุฑ</b> / <b>ุฐุงุจู</b> / <b>ุจูุน ุจูู</b><br>
    โข <b>ูู ุญุดุฑุงุช</b> / <b>ูุทุฑูุงุช</b><br>
    โข <b>ูุฑููู ุตูุฑุฉ</b> / <b>ุตูุฑุฉ ุชุงููุฉ</b><br>
    <div class="meta-line">ููู ูุชุจุช ุงุณู ุฒุฑุนุฉ ููุญุฏู (ูุซูุงู: <b>ุฑูุญุงู</b>) ูุญูููู ุนูููุง ููุฑุงู โ</div>
  `;
  addMsg(html, "bot", [
    {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"},
    {label:"ุงุดุฑุญูู ุฃูุชุฑ", fill:"ุงุดุฑุญูู"},
    {label:"ุบูุฑ ุงููุจุงุช", fill:"ุบูุฑ ุงููุจุงุช ู: "}
  ]);
}

function showPlantList(){
  const keys = Object.keys(plantDB);
  let html = `<b>ุงูุฃููุงุน ุงููุชุงุญุฉ (${keys.length}):</b><br>`;
  html += keys.map(k=>`โข ${k}`).join("<br>");
  html += `<div class="meta-line">ุงูุชุจ ุงุณู ุฃู ุฒุฑุนุฉ ูููู ููุญุฏู ุนุดุงู ุฃุญููู ูู ุนูููุง.</div>`;
  addMsg(html, "bot", [{label:"ุบูุฑ ุงููุจุงุช ูโฆ", fill:"ุบูุฑ ุงููุจุงุช ู: "}]);
}

/* =========================
   10) ุฐูุงุก ุงููุญุงุฏุซุฉ (Intent Engine)
   - ููู: โูู ุงูููุงู ุงููุชููุนโ
========================= */
const INTENTS = {
  // ุณูุงู/ุชุฑุญูุจ
  greet: /(ุงุฒูู|ุนุงูู ุงูู|ุงุฒู|ุงููุง|ููุง|ุณูุงู|ุงูุณูุงู ุนูููู|ุตุจุงุญ|ูุณุงุก|ูุงู|hello|hi)/,
  // ุดูุฑ
  thanks: /(ุดูุฑุง|ุชุณูู|ูุชุดูุฑ|ุญุจูุจู|merci|thx)/,
  // ููู ุงูุช
  who: /(ููู (ุงูุชู|ุงูุช)|ุงุณูู ุงูู|ุจุชุนููู ุงูู|ุงูุช ุงูู|ุงูุชู ุงูู)/,
  // ุณุนุฑ
  price: /(ุณุนุฑ|ูุงู|ุจูุงู|ุชูู|ุจูู)/,
  // ุตูุฑุฉ
  image: /(ุตูุฑู|ุตูุฑ|ูุฑููู|ุดูููุง|ุนุงูุฒ ุงุดูู|show|photo|picture)/,
  // ุตูุฑุฉ ุชุงููุฉ
  imageMore: /(ุตูุฑู ุชุงููู|ุตูุฑู ููุงู|ุบูุฑ ุงูุตูุฑู|ุตูุฑุฉ ุงุฎุฑู|next)/,
  // ุดุฑุญ ุฃูุชุฑ
  explain: /(ุงุดุฑุญ|ูุถุญ|ุชูุงุตูู|ุงูุชุฑ|ูุฒูุฏ|ููู ูุฏู|ุงุฒุงู|ูุนูู ุงูู)/,
  // ุฎูุงุตุฉ
  summary: /(ุฎูุงุตู|ููุฎุต|ูุฎุชุตุฑ|ุนุงูุฒ ุฎูุงุตุฉ|ุนุงูุฒ ุงูุฒุจุฏุฉ)/,

  // ููุถูุนุงุช ุฃุณุงุณูุฉ (ููุฑุฏุงุช ูุซูุฑุฉ)
  watering: /(ุฑู|ุงุณูู|ููู|ููุงู|ุนุทุด|ุฌุฏูู ุฑู|ุณูุงูุฉ|ุงุณู|ุงุณูููุง|ุงุณููู)/,
  light: /(ุดูุณ|ููุฑ|ุถูุก|ููุงู|ุงุถุงุกู|ุธู|ุฌูู|ุจุฑุง|ุจููููู|ุดุจุงู|ูู ุงูุจูุช|ุจุฑุง ุงูุจูุช)/,
  fertilize: /(ุณูุงุฏ|ุชุณููุฏ|ุบุฐุง|ุงูู|npk|ุญุฏูุฏ|ุจูุชุงุณููู|ุนูุงุตุฑ|ูุงูุณููู|ูุงุบูุณููู)/,
  soil: /(ุชุฑุจู|ุจูุชููุณ|ุฑูู|ุจูุฑูุงูุช|ุตุฑู|ุชุตุฑูู|ุทูู|ููุจูุณุช)/,
  repot: /(ุงุตูุต|ูุตุฑูู|ูุนุงุก|ููู|ุชุฏููุฑ|ุฌุฐูุฑ|ูุจุฑุช|ุชุบููุฑ ุชุฑุจุฉ|ุจุฏู ุชุฑุจุฉ)/,
  pests: /(ุญุดุฑุงุช|ูู|ุจู|ุจู ุฏูููู|ุฐุจุงุจุฉ|ุจูุถุงุก|ุนููุจูุช|ุณูุณ|ููุงูุน|ููู)/,
  fungus: /(ูุทุฑูุงุช|ุนูู|ุจูุงุถ ุฏูููู|ุจูุน ุณูุฏุงุก|ุณูุงุฏ|ุนูุงูู|ุฑูุญุฉ ูุญุดู|ูุชุญููู)/,
  symptoms: /(ุงุตูุฑ|ุงุตูุฑุงุฑ|ุฐุจู|ุฐุจูู|ูุงูุน|ุจุชูุน|ุจูุน|ุจูู|ุงุณูุฏ|ููุชูู|ููุฑูุดู|ุญุฑูู|ูุดูุงู)/,
  pruning: /(ุชูููู|ูุต|ุงูุต|ุงูุทุน|ุงูุฑุน|ุชูุฑูุน|ุชุดุฐูุจ)/,
  propagate: /(ุงูุซุงุฑ|ุนููู|ุนูู|ุจุฐูุฑ|ุฎููุงุช|ุชูุตูุต|ุชุฑููุฏ|ุชุทุนูู)/,
  toxicity: /(ุณุงู|ุณููู|ูุทุท|ููุงุจ|ุงุทูุงู|ุจูุจู|ูุงูู)/,

  // ุฃูุงูุฑ
  help: /(ุงูุงูุฑ|ูุณุงุนุฏู|help|ุชุนูููุงุช|ุงุฒุงู ุงุณุชุฎุฏู)/,
  list: /(ุงููุงุน|ุงูุงููุงุน|ูุงุฆูู|ุงููุงุฆูุฉ|ุนูุฏู ุงูู|list)/,
  clear: /(ุงูุณุญ|ูุณุญ|ุจุฏุงูุฉ ุฌุฏูุฏู|ุงุจุฏุฃ ูู ุงูุงูู|reset)/,
  change: /^(ุบูุฑ|ุจุฏู|ุญูู|ุฎูู)\s*(ุงููุจุงุช|ุงูุฒุฑุนู)?\s*(ู|ุงูู|:)\s*(.+)$/ // group4 ุงุณู ุงููุจุงุช
};

function plantChecklist(plantKey){
  const p = plantDB[plantKey];
  if(!p) return [
    "ุงูุญุต ุงูุชุฑุจุฉ ูุจู ุงูุฑู: ูุงุดูุฉ = ุงุณููุ ุทุฑูุฉ = ุงุณุชูู.",
    "ุญุทููู ูู ุถูุก ููุงุณุจ (ุบูุฑ ูุจุงุดุฑ ุฃูุถู ููุนุธู ุงูุฏุงุฎูู).",
    "ุตุฑู ูููุณ ุฃูู ุญุงุฌุฉ: ูุชุญุงุช ุฃุณูู ุงูุฃุตูุต."
  ];
  return [
    `๐ง <b>ุฑู:</b> ${p.w}`,
    `โ๏ธ <b>ููุฑ:</b> ${p.s}`,
    `๐ <b>ุณูุงุฏ:</b> ${p.f}`
  ];
}

function replyAsPlantIntro(){
  const name = state.plantKey || state.plantNameFromURL || "ูุจุงุช";
  const p = state.plantObj;
  const checklist = plantChecklist(state.plantKey).slice(0,3);

  return `
    ุงูุญูุฏููู ุชูุงู ๐ฟ๐<br>
    ุฃูุง <b>${escapeHTML(name)}</b>โฆ ูุนูุดุงู ุฃูุถู ูููุณุฉ ูุงุฒู ุชูุชู ุจูุง ุดููุฉ ๐<br><br>
    ${checklist.map(x=>`โข ${x}`).join("<br>")}
    <div class="meta-line">ููููู: โุงุดุฑุญููโ ูู ุชุญุจ ุชูุงุตูู ุฃูุชุฑุ ุฃู ุงุณุฃููู ุนู ุฃู ุนุฑุถ ุนูุฏู.</div>
  `;
}

function buildDeepExplain(topic){
  const name = state.plantKey || state.plantNameFromURL || "ูุจุงุช";
  const p = state.plantObj;

  const common = {
    watering: `
      <b>ุชูุงุตูู ุงูุฑู (ููู ุฌุฏุงู):</b><br>
      1) ุญูุท ุตุจุงุนู 3-4 ุณู ูู ุงูุชุฑุจุฉ: <b>ูุงุดู</b> = ุงุณููุ <b>ุทุฑู</b> = ุงุณุชูู.<br>
      2) ุงุณูู ูุญุฏ ูุง ุงูููู ุชูุฒู ูู ุชุญุชโฆ ูุจุนุฏูุง ูุถูู ุงูุทุจู.<br>
      3) <b>ุฒูุงุฏุฉ ุฑู</b> = ุงุตูุฑุงุฑ + ุทุฑุงูุฉ + ุฑูุญุฉ ุนูู.<br>
      4) <b>ููุฉ ุฑู</b> = ุฐุจูู + ูุฑู ูุงุดู/ููุฑูุด.<br>
      <div class="meta-line">ูู ุชููููู: ุฏุงุฎูู/ุฎุงุฑุฌู + ุญุฌู ุงูุฃุตูุต + ุงูุฌู (ุตูู/ุดุชุง) ุฃุฏูู ุฌุฏูู ุฃุฏู.</div>
    `,
    light: `
      <b>ุชูุงุตูู ุงูุถูุก/ุงูููุงู:</b><br>
      โข <b>ุดูุณ ูุจุงุดุฑุฉ</b>: ุงูุดูุณ ุชูุน ุนูู ุงููุฑู (ููุถู ุตุจุงุญ).<br>
      โข <b>ุถูุก ุบูุฑ ูุจุงุดุฑ</b>: ุงูููุงู ูููุฑ ุจุฏูู ุดูุณ ุนูู ุงููุฑู.<br>
      โข ุญุฑูู/ุจูุน ุจููุฉ = ุดูุณ ุถูุฑ ุดุฏูุฏุฉ.<br>
      โข ุณุงู ุทูููุฉ/ููู ุถุนูู = ููุต ุถูุก.<br>
      <div class="meta-line">ููู ุงูุฃุตูุต ูู ุฃุณุจูุน ุนูุดุงู ุงูููู ูุจูู ูุชูุงุฒู.</div>
    `,
    fertilize: `
      <b>ุชูุงุตูู ุงูุชุณููุฏ:</b><br>
      โข ุงูุฑุจูุน/ุงูุตูู: ุณูุงุฏ ูุชูุงุฒู ูู 3-4 ุฃุณุงุจูุน ููุนุธู ุงููุจุงุชุงุช.<br>
      โข ุงูุดุชุงุก: ูููู ุฃู ููู ุงูุชุณููุฏ ูููุจุงุชุงุช ุงูุจุทูุฆุฉ.<br>
      โข ุฃุทุฑุงู ูุญุฑููุฉ ุจุนุฏ ุชุณููุฏ = ุบุงูุจุงู <b>ุฒูุงุฏุฉ</b>โฆ ุงุบุณู ุงูุชุฑุจุฉ ุจุฑู ุบุฒูุฑ ูุฑุฉ/ูุฑุชูู.<br>
    `,
    symptoms: `
      <b>ุชุดุฎูุต ุณุฑูุน ููุฃุนุฑุงุถ:</b><br>
      โข <b>ุงุตูุฑุงุฑ</b>: ุฒูุงุฏุฉ ุฑู / ููุต ุถูุก / ููุต ุชุบุฐูุฉ.<br>
      โข <b>ุฐุจูู</b>: ููุฉ ุฑู ุฃู ุฌุฐูุฑ ูุชุนููุฉ (ูู ุงูุชุฑุจุฉ ุทุฑูุฉ).<br>
      โข <b>ุจูุน ุจููุฉ</b>: ุดูุณ ุฒูุงุฏุฉ ุฃู ูุทุฑูุงุช ุฃู ุฃููุงุญ.<br>
      โข <b>ุณููุท ูุฑู</b>: ุตุฏูุฉ ููู ููุงู/ุจุฑุฏ/ุฑู ุบูุท.<br>
      <div class="meta-line">ููููู 3 ุญุงุฌุงุช: (ุฏุงุฎู/ุฎุงุฑุฌ) + (ุจุชุณูู ูู ูุฏ ุงูู) + (ุฅุถุงุกุฉ) ููุฏูู ุชุดุฎูุต ุฃุฏู.</div>
    `,
    pests: `
      <b>ุญุดุฑุงุช โ ุฎุทุฉ ุฅููุงุฐ:</b><br>
      1) ุงุนุฒููู ุนู ุจุงูู ุงูุฒุฑุน.<br>
      2) ุงูุณุญ ุงููุฑู ุจููุฉ + ุตุงุจูู ูุทูู/ุตุงุจูู ุจูุชุงุณููู (ุซู ุงุดุทู).<br>
      3) ุฑุด ุฒูุช ููู (ูู ููุฌูุฏ) ูู 5-7 ุฃูุงู ูุญุฏ ูุง ุชุฎุชูู.<br>
      4) ูุต ุงูุฃูุฑุงู ุงููุชุถุฑุฑุฉ ุฌุฏุงู.<br>
      <div class="meta-line">ููููู ุดูู ุงูุญุดุฑุฉ (ููุท ุจูุถุง/ูุทู/ุดุจู) ูุฃูุง ุฃุญุฏุฏูุง ูู.</div>
    `,
    repot: `
      <b>ููู/ุชุฏููุฑ ุงูุฃุตูุต:</b><br>
      โข ุงููู ููุง ุงูุฌุฐูุฑ ุชููุฃ ุงูุฃุตูุต ุฃู ุงูููู ุชุนุฏูู ุจุณุฑุนุฉ.<br>
      โข ูุจุฑ ุงูููุงุณ โุฏุฑุฌุฉ ูุงุญุฏุฉโ ููุท.<br>
      โข ุจุนุฏ ุงูููู: ุงุณูู ูุฑุฉ ูููุณ ูุจูุงุด ุชุณููุฏ ุฃุณุจูุนูู.<br>
    `,
    soil: `
      <b>ุงูุชุฑุจุฉ ุงูุตุญ:</b><br>
      โข ุฃูู ุญุงุฌุฉ: <b>ุฎูููุฉ + ุชุตุฑูู</b>.<br>
      โข ููุตุจุงุฑุงุช: ุฒููุฏ ุฑูู/ุจูุฑูุงูุช ููููู ุงูุนุถูู.<br>
      โข ููุธู ูุงูุฑุทูุจุฉ: ุฒููุฏ ููุจูุณุช ูุฎูู ุงูุฑู ุจุญุณุงุจ.<br>
    `,
    pruning: `
      <b>ุงูุชูููู:</b><br>
      โข ูุต ุงูููู = ุชูุฑูุน ููุซุงูุฉ.<br>
      โข ุดูู ุงููุฑู ุงูุฏุจูุงู ุฃูู ุจุฃูู.<br>
      โข ููุต ูุธููโฆ ูุฎูู ุงููุต ููู ุนูุฏุฉ/ุจุฑุนู.<br>
    `,
    propagate: `
      <b>ุงูุฅูุซุงุฑ:</b><br>
      โข ุงููุชุณููุงุช: ุนููุฉ ุจุนูุฏุฉ ูู ููุฉ/ุชุฑุจุฉ.<br>
      โข ุงูุนุตุงุฑูุงุช: ูุฑูุฉ/ุฎููุงุช ุจุนุฏ ูุง ููุงู ุงููุทุน ููุดู.<br>
      โข ุงูุฃุนุดุงุจ: ุนูู ุฃู ุจุฐูุฑ ุญุณุจ ุงูููุน.<br>
    `,
    toxicity: `
      <b>ุงูุณูููุฉ:</b><br>
      ุจุนุถ ุงููุจุงุชุงุช ูููู ุชุถุฑ ูู ุงุชุงููุช (ุฎุตูุตุงู ุฏุงุฎููุงุช ูุนููุฉ).<br>
      ูู ุนูุฏู ูุทุท/ููุงุจ ุฃู ุฃุทูุงูโฆ ููููู ุงุณู ุงููุจุงุช ูุฃูุง ุฃูุจูู ุจุญุฐุฑ ููุงุณุจ.<br>
    `
  };

  // ุฏูุฌ ุชูุงุตูู ุงููุจุงุช ูุน ุงูุนุงู
  if(p && (topic==="watering" || topic==="light" || topic==="fertilize")){
    const head = (topic==="watering") ? `๐ง <b>ุจุงููุณุจุฉ ูู ${escapeHTML(name)}:</b> ${p.w}` :
                 (topic==="light")    ? `โ๏ธ <b>ุจุงููุณุจุฉ ูู ${escapeHTML(name)}:</b> ${p.s}` :
                                        `๐ <b>ุจุงููุณุจุฉ ูู ${escapeHTML(name)}:</b> ${p.f}`;
    return `${head}<br><br>${common[topic]}`;
  }

  return common[topic] || common.symptoms;
}

function priceReply(){
  return `ุงูุฃุณุนุงุฑ ุจุชุชุบูุฑ ุญุณุจ <b>ุงูุญุฌู</b> ู<b>ุงูููุณู</b> ๐<br>ุดุฑููุง ูู ุงููุดุชู ููุงุจุชู ูุญูุฏ ููุนูู ูุนุงู ุฃุญูู ูุงุฌุจ! ๐`;
}

/* =========================
   11) ุงูุชุดุงู โุงุณู ุฒุฑุนุฉโ ูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู (ุชุจุฏูู ุณุฑูุน)
   - ูู ุงููุณุชุฎุฏู ูุชุจ: "ุฑูุญุงู" ููุท โ ูุญูู ููุฑุงู
   - ุฃู ูู ูุชุจ: "ุนุงูุฒ ุฑูุญุงู" โ ูุญูู ุจุฑุถู
========================= */
function extractPlantMention(text){
  const t = normalizeArabic(text);
  if(!t) return null;

  // ูููุงุช ูุณุงุนุฏุฉ ุชูุดุงู
  const cleaned = t
    .replace(/(ุนุงูุฒ|ุนุงูุฒู|ุนุงูุฒ|ูููู|ูู ูุถูู|ูู ุณูุญุช|ุฌุฑุจ|ุนุงูุฒุฉ|ุจุฏู|ุบูุฑ|ุญูู|ุฎูู)/g," ")
    .replace(/\s+/g," ")
    .trim();

  // ูู ุงูุฌููุฉ ูุตูุฑุฉุ ูููู ุชููู ุงุณู ุฒุฑุนุฉ
  if(cleaned.split(" ").length <= 3){
    const k = findPlantKeyByName(cleaned);
    if(k) return k;
  }

  // ุจุญุซ ุฏุงุฎู ุงูููุงู ุนู ุงุณู ุฒุฑุนุฉ
  for(const key of Object.keys(plantDB)){
    const nk = normalizeArabic(key);
    if(t.includes(nk)) return key;
    for(const al of (plantDB[key].aliases || [])){
      const na = normalizeArabic(al);
      if(na && t.includes(na)) return key;
    }
  }
  return null;
}

/* =========================
   12) ุงูููุทู ุงูุฑุฆูุณู ููุฑุฏ
========================= */
function detectIntent(text){
  const t = normalizeArabic(text);

  // ุฃูุงูุฑ
  const changeMatch = t.match(INTENTS.change);
  if(changeMatch && changeMatch[4]) return { intent:"change", value: changeMatch[4].trim() };
  if(INTENTS.clear.test(t)) return { intent:"clear" };
  if(INTENTS.help.test(t)) return { intent:"help" };
  if(INTENTS.list.test(t)) return { intent:"list" };

  // ุตูุฑ
  if(INTENTS.imageMore.test(t)) return { intent:"image_more" };
  if(INTENTS.image.test(t)) return { intent:"image" };

  // ุฃุณุงุณูุงุช
  if(INTENTS.price.test(t)) return { intent:"price" };
  if(INTENTS.thanks.test(t)) return { intent:"thanks" };
  if(INTENTS.who.test(t)) return { intent:"who" };
  if(INTENTS.greet.test(t)) return { intent:"greet" };

  // ููุถูุนุงุช
  if(INTENTS.summary.test(t)) return { intent:"topic", topic:"summary" };
  if(INTENTS.watering.test(t)) return { intent:"topic", topic:"watering" };
  if(INTENTS.light.test(t)) return { intent:"topic", topic:"light" };
  if(INTENTS.fertilize.test(t)) return { intent:"topic", topic:"fertilize" };
  if(INTENTS.soil.test(t)) return { intent:"topic", topic:"soil" };
  if(INTENTS.repot.test(t)) return { intent:"topic", topic:"repot" };
  if(INTENTS.pests.test(t)) return { intent:"topic", topic:"pests" };
  if(INTENTS.fungus.test(t)) return { intent:"topic", topic:"fungus" };
  if(INTENTS.symptoms.test(t)) return { intent:"topic", topic:"symptoms" };
  if(INTENTS.pruning.test(t)) return { intent:"topic", topic:"pruning" };
  if(INTENTS.propagate.test(t)) return { intent:"topic", topic:"propagate" };
  if(INTENTS.toxicity.test(t)) return { intent:"topic", topic:"toxicity" };

  // ุดุฑุญ
  if(INTENTS.explain.test(t)) return { intent:"explain" };

  // ุบูุฑ ูุนุฑูู
  return { intent:"unknown" };
}

function buildSummaryReply(){
  const name = state.plantKey || state.plantNameFromURL || "ูุจุงุช";
  const list = plantChecklist(state.plantKey);
  const html = `
    <b>ุฎูุงุตุฉ ุนูุงูุฉ ${escapeHTML(name)} ๐</b><br>
    ${list.map(x=>`โข ${x}`).join("<br>")}
    <div class="meta-line">ูู ุนุงูุฒ ุชูุงุตูู: ููู โุงุดุฑุญููโ โ</div>
  `;
  state.lastTopic = "summary";
  state.lastAdvice = html;
  return html;
}

function unknownFallback(userText){
  const name = state.plantKey || state.plantNameFromURL || "ูุจุงุช";
  const t = normalizeArabic(userText);

  let html = `
    ุชูุงู ูุง ุตุงุญุจู โ<br>
    ุฃูุง <b>${escapeHTML(name)}</b>โฆ ุฎูููู ุฃุณุงุนุฏู ุจุดูู ุฐูู ุญุชู ูู ุงูุณุคุงู ุนุงู.<br><br>
    <b>ูููู ุงููู ุนูุฏู ุจุงูุธุจุท:</b> (ุงุตูุฑุงุฑุ ุฐุจููุ ุญุดุฑุงุชุ ุฑูุ ููุงูุ)<br>
    <div class="meta-line">ูู ุชุญุจ: ุงูุชุจ โุฎูุงุตุฉ ุงูุนูุงูุฉโ ุฃู โุงุดุฑุญููโ</div>
  `;

  // ูุญุงููุฉ ุชููุงุฆูุฉ ูุชูุณูุฑ
  if(/ุงุตูุฑ|ุงุตูุฑุงุฑ/.test(t)){
    html = `ูู ูุฑูู ุจูุตูุฑ ุบุงูุจุงู ุงูุณุจุจ ูุงุญุฏ ูู ุฏูู:<br>
    โข <b>ุฒูุงุฏุฉ ุฑู</b> (ุงูุฃุดูุฑ) โ ุฎููู ุงูุชุฑุจุฉ ุชูุดู ูุจู ุงูุฑู.<br>
    โข <b>ููุต ุถูุก</b> โ ุฒููุฏ ุงูุฅุถุงุกุฉ ุชุฏุฑูุฌููุง.<br>
    โข <b>ููุต ุชุบุฐูุฉ</b> โ ุณูุงุฏ ูุชูุงุฒู ุฎููู ูู 3-4 ุฃุณุงุจูุน (ูู ุงูุฑุจูุน/ุงูุตูู).<br>
    <div class="meta-line">ููููู: ุจุชุณูู ูู ูุฏ ุงููุ ูุงูุง ุฏุงุฎู ููุง ุฎุงุฑุฌุ</div>`;
    state.lastTopic = "symptoms";
    state.lastAdvice = html;
  } else if(/ุฐุจู|ุฐุจูู|ูุชูุฏู/.test(t)){
    html = `ูู ุฃูุง ุฐุงุจูโฆ ุงุนูู ุงุฎุชุจุงุฑ ุณุฑูุน:<br>
    โข ูู ุงูุชุฑุจุฉ <b>ูุงุดูุฉ</b>: ุงุณูููู ูููุณ ูุญุฏ ูุง ุงูููู ุชูุฒู ูู ุชุญุช.<br>
    โข ูู ุงูุชุฑุจุฉ <b>ุทุฑูุฉ/ูุจูููุฉ</b>: ูุจูู ุฒูุงุฏุฉ ุฑู/ุชุนููโฆ ููู ุฑู ูุคูุชุงู ูุญุณูู ุงูุตุฑู.<br>
    <div class="meta-line">ููููู ุฑูุญุฉ ุงูุชุฑุจุฉ ุงููุ ูููู ุณูุงุฏ ูู ุงูุณุงูุ</div>`;
    state.lastTopic = "symptoms";
    state.lastAdvice = html;
  } else if(/ุญุดุฑุงุช|ุจู|ูู|ุฐุจุงุจุฉ/.test(t)){
    html = buildDeepExplain("pests");
    state.lastTopic = "pests";
    state.lastAdvice = html;
  }

  return html;
}

function replyLogic(){
  const input = document.getElementById("userInput");
  const raw = input.value || "";
  const text = raw.trim();
  if(!text) return;

  addMsg(escapeHTML(text), "user");
  input.value = "";

  const typingNode = addTyping();

  setTimeout(()=>{
    // 1) ุชุจุฏูู ุฒุฑุนุฉ ุชููุงุฆู ูู ุงููุณุชุฎุฏู ูุชุจ ุงุณู ุฒุฑุนุฉ (ุจุฏูู ูุง ูุชุนุจ)
    const mentioned = extractPlantMention(text);
    const intentFirst = detectIntent(text);

    // ูู ุงููุณุชุฎุฏู ูุชุจ ุงุณู ุฒุฑุนุฉ ููุญุฏู ุฃู ุถูู ููุงููโฆ ูุญุงููุงู ุฒุฑุนุฉ ูุฎุชููุฉ โ ูุญูู
    if(mentioned && mentioned !== state.plantKey && intentFirst.intent !== "price"){
      setPlant(mentioned);
      document.getElementById("chatBox").innerHTML = ""; // ูุจุฏุฃ ุดุงุช ูุธูู ูุน ุงูุฒุฑุนุฉ ุงูุฌุฏูุฏุฉ
      removeTyping(typingNode);
      welcome(`ุชูุงู โ ุจููุช ุฃูุง <b>${escapeHTML(mentioned)}</b>โฆ ุงุณุฃููู ุจูู ุจุฑุงุญุชู.`);
      return;
    }

    // 2) ูููู ุจุงูู intent ุงูุทุจูุนู
    const intent = intentFirst;

    let html = "";
    let actions = [];

    if(intent.intent === "clear"){
      removeTyping(typingNode);
      resetChat();
      return;
    }

    if(intent.intent === "help"){
      removeTyping(typingNode);
      showHelp();
      return;
    }

    if(intent.intent === "list"){
      removeTyping(typingNode);
      showPlantList();
      return;
    }

    if(intent.intent === "change"){
      const name = intent.value;
      const k = findPlantKeyByName(name) || name;
      setPlant(k);
      document.getElementById("chatBox").innerHTML = "";
      removeTyping(typingNode);
      welcome(`ุชูุงู โ ุญููุช ูู ุนูู: <b>${escapeHTML(state.plantKey || state.plantNameFromURL)}</b>`);
      return;
    }

    if(intent.intent === "price"){
      html = priceReply();
      state.lastTopic = "price";
      state.lastAdvice = html;
      actions = [
        {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"},
        {label:"ูุฑููู ุตูุฑุฉ", fill:"ูุฑููู ุตูุฑุฉ"}
      ];
    }
    else if(intent.intent === "thanks"){
      html = "ุงูุนูู ูุง ุบุงูู! ููุฑุชูุง ๐<div class='meta-line'>ูู ุงุญุชุฌุช ุฃู ุญุงุฌุฉ ุนู ุงูุฑู/ุงูุดูุณ/ุงูุฃุนุฑุงุถ ุฃูุง ููุฌูุฏ.</div>";
      state.lastTopic = "thanks";
      actions = [
        {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"},
        {label:"ุงุดุฑุญูู", fill:"ุงุดุฑุญูู"}
      ];
    }
    else if(intent.intent === "who"){
      const name = state.plantKey || state.plantNameFromURL || "ุฒุฑุนุฉ";
      html = `ุฃูุง <b>${escapeHTML(name)}</b> ๐ฑ<br>
      ูุธููุชู ุฃุณุงุนุฏู ุชูุชู ุจูุง ุตุญโฆ ุนุงูุฒูู ุฃูููู ุงูุฑู ููุง ุงูููุงู ููุง ุฃุนุงูุฌ ุนุฑุถ ูุนููุ`;
      state.lastTopic = "who";
      state.lastAdvice = html;
      actions = [
        {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"},
        {label:"ุงูุชู ุฃุณููุ", fill:"ุงูุชู ุฃุณููุ"},
        {label:"ุฃุญุทู ูููุ", fill:"ุฃุญุทู ูููุ"}
      ];
    }
    else if(intent.intent === "greet"){
      html = replyAsPlantIntro();
      state.lastTopic = "greet";
      state.lastAdvice = html;
      actions = [
        {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"},
        {label:"ุงุดุฑุญูู", fill:"ุงุดุฑุญูู"},
        {label:"ูุฑูู ุจูุตูุฑ", fill:"ูุฑูู ุจูุตูุฑโฆ ูููุ"}
      ];
    }
    else if(intent.intent === "image"){
      updatePlantImage(false);
      const imgSrc = document.getElementById("plantImg").src;
      const name = state.plantKey || state.plantNameFromURL || "ุงููุจุงุช";
      html = `ุงุชูุถู ๐ฟ ุฏู ุตูุฑุฉ <b>${escapeHTML(name)}</b>:<br><img class="img-reply" src="${imgSrc}" alt="plant">`;
      state.lastTopic = "image";
      state.lastAdvice = html;
      actions = [
        {label:"ุตูุฑุฉ ุชุงููุฉ", fill:"ุตูุฑุฉ ุชุงููุฉ"},
        {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"}
      ];
    }
    else if(intent.intent === "image_more"){
      state.imgIndex++;
      updatePlantImage(false);
      const imgSrc = document.getElementById("plantImg").src;
      const name = state.plantKey || state.plantNameFromURL || "ุงููุจุงุช";
      html = `ุตูุฑุฉ ููุงู ูู <b>${escapeHTML(name)}</b> ๐<br><img class="img-reply" src="${imgSrc}" alt="plant">`;
      state.lastTopic = "image";
      state.lastAdvice = html;
      actions = [
        {label:"ุตูุฑุฉ ุชุงููุฉ", fill:"ุตูุฑุฉ ุชุงููุฉ"},
        {label:"ุงูุชู ุฃุณููุ", fill:"ุงูุชู ุฃุณููุ"}
      ];
    }
    else if(intent.intent === "topic"){
      if(intent.topic === "summary"){
        html = buildSummaryReply();
      } else {
        html = buildDeepExplain(intent.topic);
        state.lastTopic = intent.topic;
        state.lastAdvice = html;
      }

      actions = [
        {label:"ุงุดุฑุญูู", fill:"ุงุดุฑุญูู"},
        {label:"ูุฑููู ุตูุฑุฉ", fill:"ูุฑููู ุตูุฑุฉ"},
        {label:"ุญุดุฑุงุช", fill:"ูู ุญุดุฑุงุชโฆ ุฃุนูู ุงููุ"},
        {label:"ุงุตูุฑุงุฑ", fill:"ูุฑูู ุจูุตูุฑโฆ ูููุ"}
      ];
    }
    else if(intent.intent === "explain"){
      // ูุดุฑุญ ุขุฎุฑ ุญุงุฌุฉ
      const topic = state.lastTopic || "summary";
      if(topic === "summary"){
        html = buildDeepExplain("watering") + "<br><br>" + buildDeepExplain("light");
      } else {
        html = buildDeepExplain(topic);
      }
      state.lastAdvice = html;

      actions = [
        {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"},
        {label:"ุงูุชู ุฃุณููุ", fill:"ุงูุชู ุฃุณููุ"},
        {label:"ุฃุญุทู ูููุ", fill:"ุฃุญุทู ูููุ"}
      ];
    }
    else {
      html = unknownFallback(text);
      actions = [
        {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"},
        {label:"ุงูุชู ุฃุณููุ", fill:"ุงูุชู ุฃุณููุ"},
        {label:"ุฃุญุทู ูููุ", fill:"ุฃุญุทู ูููุ"},
        {label:"ูู ุญุดุฑุงุช", fill:"ูู ุญุดุฑุงุชโฆ ุฃุนูู ุงููุ"}
      ];
    }

    removeTyping(typingNode);
    addMsg(html, "bot", actions);
  }, 650);
}

/* =========================
   13) ุชุฑุญูุจ
========================= */
function welcome(custom=null){
  const display = state.plantKey || state.plantNameFromURL || "ุนุงูุฉ";
  let html = custom ? custom + "<br><br>" : "";
  html += `ูุง ุฃููุงู ๐ ุฃูุง <b>${escapeHTML(display)}</b> ๐ฑ<br>`;
  html += `ูููู ุฃู ุญุงุฌุฉโฆ ูุฃูุง ูุงูููู ๐<br>`;
  html += `<div class="meta-line">ูููู ุชูุชุจ ุงุณู ุฒุฑุนุฉ ุจุณ (ูุซุงู: <b>ุฑูุญุงู</b>) ุนูุดุงู ุฃุญูููู ุนูููุง ููุฑุงู.</div>`;

  addMsg(html, "bot", [
    {label:"ุงุฒููุ", fill:"ุงุฒููุ"},
    {label:"ุฎูุงุตุฉ ุงูุนูุงูุฉ", fill:"ุฎูุงุตุฉ ุงูุนูุงูุฉ"},
    {label:"ูุฑููู ุตูุฑุฉ", fill:"ูุฑููู ุตูุฑุฉ"}
  ]);
}

/* =========================
   14) Voice (ุงุฎุชูุงุฑู)
========================= */
function toggleVoice(){
  const btn = document.getElementById("voiceBtn");
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    addMsg("ููุฃุณู ุงููุชุตูุญ ุฏู ูุด ุจูุฏุนู ุงูุฅููุงุก ุงูุตูุชู ๐", "bot");
    return;
  }

  if(!state.recognition){
    state.recognition = new SpeechRecognition();
    state.recognition.lang = "ar-EG";
    state.recognition.interimResults = false;
    state.recognition.maxAlternatives = 1;
    state.recognition.onresult = (event)=>{
      const transcript = event.results?.[0]?.[0]?.transcript || "";
      document.getElementById("userInput").value = transcript;
      btn.classList.remove("active");
      state.voiceOn = false;
    };
    state.recognition.onerror = ()=>{
      btn.classList.remove("active");
      state.voiceOn = false;
    };
    state.recognition.onend = ()=>{
      btn.classList.remove("active");
      state.voiceOn = false;
    };
  }

  if(state.voiceOn){
    state.recognition.stop();
    state.voiceOn = false;
    btn.classList.remove("active");
  }else{
    state.recognition.start();
    state.voiceOn = true;
    btn.classList.add("active");
  }
}

/* =========================
   15) Start
========================= */
(function init(){
  const params = new URLSearchParams(window.location.search);
  const rawType = params.get("type") || "ุนุงูุฉ";
  const keep = params.get("keep") === "1";

  // ุญู ูุดููุฉ "ุญุงูุธ ูููุชูู"
  if(SETTINGS.RESET_ON_LOAD && !keep){
    // ูุด ููุญูุธ ุฃุตูุงูโฆ ูุฌุฑุฏ ุถูุงู
    sessionStorage.clear();
  }

  const pType = rawType.replace(/_/g," ");
  setPlant(pType);

  // ุงุจุฏุฃ ุฌุฏูุฏ ุฏุงุฆูุงู (ููู ููู QR)
  resetChat();
})();
</script>
</body>
</html>
